<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>지식베이스 - GrowFit</title>
    <style>
/* ========== CSS Variables ========== */
:root {
    --primary-50: #faf5ff;
    --primary-100: #f3e8ff;
    --primary-200: #e9d5ff;
    --primary-300: #d8b4fe;
    --primary-400: #c084fc;
    --primary-500: #a855f7;
    --primary-600: #9333ea;
    --primary-700: #7e22ce;
    --primary-800: #6b21a8;
    --primary-900: #581c87;

    --gray-50: #f8fafc;
    --gray-100: #f1f5f9;
    --gray-200: #e2e8f0;
    --gray-300: #cbd5e1;
    --gray-400: #94a3b8;
    --gray-500: #64748b;
    --gray-600: #475569;
    --gray-700: #334155;
    --gray-800: #1e293b;
    --gray-900: #0f172a;

    --success: #10b981;
    --success-light: #d1fae5;
    --warning: #f59e0b;
    --warning-light: #fef3c7;
    --error: #ef4444;
    --error-light: #fee2e2;
    --info: #3b82f6;
    --info-light: #dbeafe;

    --background: #ffffff;
    --surface: #f8fafc;
    --border: #e2e8f0;
    --text-primary: #0f172a;
    --text-secondary: #475569;
    --text-tertiary: #94a3b8;

    --sidebar-width: 260px;
    --header-height: 56px;
    --font-sans: -apple-system, BlinkMacSystemFont, "Pretendard", "Segoe UI", sans-serif;
    --radius-sm: 4px;
    --radius-md: 8px;
    --radius-lg: 12px;
    --radius-xl: 16px;
    --radius-full: 9999px;
    --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
    --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1);
    --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1);
}

* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: var(--font-sans); background: var(--background); color: var(--text-primary); height: 100vh; overflow: hidden; }

.icon { width: 20px; height: 20px; stroke: currentColor; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; fill: none; flex-shrink: 0; }
.icon--sm { width: 16px; height: 16px; }
.icon--lg { width: 24px; height: 24px; }

.app { display: flex; height: 100vh; }

/* ========== Sidebar ========== */
.sidebar { width: var(--sidebar-width); background: var(--background); border-right: 1px solid var(--border); display: flex; flex-direction: column; flex-shrink: 0; }
.sidebar__header { padding: 16px; border-bottom: 1px solid var(--border); }
.sidebar__logo { display: flex; align-items: center; gap: 10px; margin-bottom: 16px; }
.sidebar__logo-icon { width: 32px; height: 32px; background: linear-gradient(135deg, var(--primary-500), var(--primary-700)); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; color: white; }
.sidebar__logo-text { font-size: 14px; font-weight: 700; color: var(--text-primary); }
.sidebar__logo-badge { background: var(--primary-600); color: white; font-size: 10px; font-weight: 600; padding: 2px 6px; border-radius: var(--radius-sm); }

.sidebar__new-chat { display: flex; align-items: center; justify-content: center; gap: 8px; width: 100%; padding: 10px; border: 1px dashed var(--border); border-radius: var(--radius-md); background: transparent; font-size: 13px; font-weight: 500; color: var(--text-secondary); cursor: pointer; transition: all 0.2s; }
.sidebar__new-chat:hover { background: var(--surface); border-color: var(--primary-300); color: var(--primary-600); }

/* Class Selector */
.class-selector { margin-bottom: 16px; position: relative; }
.class-selector__button { width: 100%; display: flex; align-items: center; gap: 10px; padding: 10px 12px; background: linear-gradient(135deg, var(--primary-50), var(--primary-100)); border: 1px solid var(--primary-200); border-radius: var(--radius-md); cursor: pointer; transition: all 0.2s; text-align: left; }
.class-selector__button:hover { border-color: var(--primary-300); background: linear-gradient(135deg, var(--primary-100), var(--primary-200)); }
.class-selector__button.open { border-color: var(--primary-400); }
.class-selector__icon { width: 36px; height: 36px; background: var(--primary-600); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; color: white; }
.class-selector__info { flex: 1; min-width: 0; }
.class-selector__name { font-size: 13px; font-weight: 600; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.class-selector__meta { display: flex; align-items: center; gap: 8px; margin-top: 3px; }
.class-selector__status { display: inline-flex; align-items: center; gap: 4px; font-size: 11px; font-weight: 500; }
.class-selector__status--active { color: var(--success); }
.class-selector__status-dot { width: 6px; height: 6px; border-radius: var(--radius-full); background: currentColor; }
.class-selector__dday { font-size: 11px; font-weight: 600; color: var(--primary-600); background: var(--primary-100); padding: 2px 6px; border-radius: var(--radius-sm); }
.class-selector__arrow { color: var(--text-tertiary); transition: transform 0.2s; }
.class-selector__button.open .class-selector__arrow { transform: rotate(180deg); }

/* Class Dropdown */
.class-dropdown { position: absolute; top: calc(100% + 4px); left: 0; right: 0; background: var(--background); border: 1px solid var(--border); border-radius: var(--radius-lg); box-shadow: var(--shadow-lg); z-index: 1000; opacity: 0; visibility: hidden; transform: translateY(-8px); transition: all 0.2s; max-height: 300px; overflow-y: auto; }
.class-dropdown--open { opacity: 1; visibility: visible; transform: translateY(0); }
.class-dropdown__section { padding: 8px; }
.class-dropdown__section-title { font-size: 10px; font-weight: 600; color: var(--text-tertiary); text-transform: uppercase; letter-spacing: 0.5px; padding: 8px 10px 6px; }
.class-dropdown__item { display: flex; align-items: center; gap: 10px; padding: 10px; border-radius: var(--radius-md); cursor: pointer; transition: background 0.2s; }
.class-dropdown__item:hover { background: var(--surface); }
.class-dropdown__item--active { background: var(--primary-50); }
.class-dropdown__item--disabled { opacity: 0.6; }
.class-dropdown__item--disabled:hover { background: var(--gray-50); }
.class-dropdown__item-icon { width: 32px; height: 32px; border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
.class-dropdown__item-icon--active { background: var(--primary-100); color: var(--primary-600); }
.class-dropdown__item-icon--ended { background: var(--gray-100); color: var(--gray-400); }
.class-dropdown__item-info { flex: 1; min-width: 0; }
.class-dropdown__item-name { font-size: 13px; font-weight: 500; color: var(--text-primary); }
.class-dropdown__item-period { font-size: 11px; color: var(--text-tertiary); margin-top: 2px; }
.class-dropdown__item-badge { font-size: 10px; font-weight: 600; padding: 2px 8px; border-radius: var(--radius-full); }
.class-dropdown__item-badge--active { background: var(--success); color: white; }
.class-dropdown__item-badge--ended { background: var(--gray-200); color: var(--text-tertiary); }
.class-dropdown__divider { height: 1px; background: var(--border); margin: 4px 8px; }

.sidebar__nav { padding: 8px 12px; border-bottom: 1px solid var(--border); }
.sidebar__nav-item { display: flex; align-items: center; gap: 10px; padding: 10px 12px; border-radius: var(--radius-md); color: var(--text-secondary); text-decoration: none; font-size: 13px; font-weight: 500; cursor: pointer; transition: all 0.2s; margin-bottom: 2px; }
.sidebar__nav-item:hover { background: var(--surface); color: var(--text-primary); }
.sidebar__nav-item--active { background: var(--primary-50); color: var(--primary-600); }
.sidebar__nav-icon { width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; }

.sidebar__section-header { display: flex; align-items: center; justify-content: space-between; padding: 16px 16px 8px; }
.sidebar__section-title { font-size: 11px; font-weight: 600; color: var(--text-tertiary); text-transform: uppercase; letter-spacing: 0.5px; }
.sidebar__section-search { width: 24px; height: 24px; border: none; background: transparent; border-radius: var(--radius-sm); cursor: pointer; color: var(--text-tertiary); display: flex; align-items: center; justify-content: center; }
.sidebar__section-search:hover { background: var(--surface); color: var(--text-primary); }
.sidebar__history { flex: 1; overflow-y: auto; padding: 0 8px; }

.chat-item { display: flex; align-items: center; gap: 10px; padding: 10px 12px; border-radius: var(--radius-md); cursor: pointer; transition: all 0.2s; margin-bottom: 2px; position: relative; }
.chat-item:hover { background: var(--surface); }
.chat-item--active { background: var(--primary-50); }
.chat-item__pin-dot { width: 6px; height: 6px; border-radius: var(--radius-full); background: var(--warning); flex-shrink: 0; }
.chat-item__icon { width: 32px; height: 32px; border-radius: var(--radius-md); background: var(--gray-100); display: flex; align-items: center; justify-content: center; color: var(--text-tertiary); flex-shrink: 0; }
.chat-item--active .chat-item__icon { background: var(--primary-100); color: var(--primary-600); }
.chat-item__info { flex: 1; min-width: 0; }
.chat-item__title { font-size: 13px; font-weight: 500; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.chat-item__meta { display: flex; align-items: center; gap: 6px; margin-top: 2px; }
.chat-item__time { font-size: 11px; color: var(--text-tertiary); }
.chat-item__project-badge { display: inline-flex; align-items: center; gap: 3px; font-size: 10px; font-weight: 500; padding: 1px 6px; border-radius: var(--radius-sm); background: var(--primary-100); color: var(--primary-600); max-width: 80px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.chat-item__project-badge svg { width: 10px; height: 10px; flex-shrink: 0; }
.chat-item__menu { width: 24px; height: 24px; border: none; background: transparent; border-radius: var(--radius-sm); cursor: pointer; color: var(--text-tertiary); opacity: 0; transition: all 0.2s; display: flex; align-items: center; justify-content: center; }
.chat-item:hover .chat-item__menu { opacity: 1; }
.chat-item__menu:hover { background: var(--gray-200); color: var(--text-primary); }

/* Context Menu */
.context-menu { position: fixed; min-width: 180px; background: var(--background); border: 1px solid var(--border); border-radius: var(--radius-lg); box-shadow: var(--shadow-lg); z-index: 9999; padding: 4px; opacity: 0; visibility: hidden; }
.context-menu--open { opacity: 1; visibility: visible; }
.context-menu__item { display: flex; align-items: center; gap: 8px; padding: 8px 12px; font-size: 13px; color: var(--text-primary); cursor: pointer; border-radius: var(--radius-md); transition: background 0.2s; }
.context-menu__item:hover { background: var(--surface); }
.context-menu__item--danger { color: var(--error); }
.context-menu__item--danger:hover { background: #fef2f2; }
.context-menu__item--project-add { color: var(--success); }
.context-menu__item--project-add:hover { background: #ecfdf5; }
.context-menu__item--project-change { color: var(--info); }
.context-menu__item--project-change:hover { background: #eff6ff; }
.context-menu__item--project-remove { color: var(--warning); }
.context-menu__item--project-remove:hover { background: #fffbeb; }
.context-menu__divider { height: 1px; background: var(--border); margin: 4px 0; }

.sidebar__footer { border-top: 1px solid var(--border); padding: 8px; }
.sidebar__footer-item { display: flex; align-items: center; gap: 10px; padding: 10px 12px; border-radius: var(--radius-md); cursor: pointer; transition: all 0.2s; color: var(--text-secondary); font-size: 13px; }
.sidebar__footer-item:hover { background: var(--surface); color: var(--text-primary); }
.sidebar__user { display: flex; align-items: center; gap: 10px; padding: 10px 12px; border-radius: var(--radius-md); cursor: pointer; transition: all 0.2s; }
.sidebar__user:hover { background: var(--surface); }
.sidebar__user-avatar { width: 32px; height: 32px; border-radius: var(--radius-full); background: linear-gradient(135deg, var(--primary-400), var(--primary-600)); color: white; display: flex; align-items: center; justify-content: center; font-size: 13px; font-weight: 600; }
.sidebar__user-name { flex: 1; font-size: 13px; font-weight: 500; color: var(--text-primary); }
.sidebar__logout { color: var(--text-tertiary); }

/* ========== Main ========== */
.main { flex: 1; display: flex; flex-direction: column; min-width: 0; background: var(--surface); }

.page-header { display: flex; align-items: center; justify-content: space-between; padding: 16px 24px; background: var(--background); border-bottom: 1px solid var(--border); }
.page-header__left { display: flex; align-items: center; gap: 12px; }
.page-header__title { font-size: 18px; font-weight: 700; color: var(--text-primary); }
.page-header__right { display: flex; align-items: center; gap: 8px; }

.btn { display: inline-flex; align-items: center; justify-content: center; gap: 6px; padding: 8px 16px; border-radius: var(--radius-md); font-size: 13px; font-weight: 500; cursor: pointer; transition: all 0.2s; border: none; }
.btn--primary { background: var(--primary-600); color: white; }
.btn--primary:hover { background: var(--primary-700); }
.btn--outline { background: var(--background); border: 1px solid var(--border); color: var(--text-primary); }
.btn--outline:hover { background: var(--surface); border-color: var(--primary-300); }
.btn--sm { padding: 6px 12px; font-size: 12px; }
.btn--lg { padding: 12px 24px; font-size: 14px; }

/* ========== KB Content ========== */
.kb-content { flex: 1; overflow-y: auto; padding: 32px 24px; }

/* Mode Selection */
.mode-selection { max-width: 1200px; margin: 0 auto; }
.mode-selection__header { text-align: center; margin-bottom: 32px; }
.mode-selection__title { font-size: 24px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px; }
.mode-selection__desc { font-size: 14px; color: var(--text-secondary); }

.mode-cards { display: grid; grid-template-columns: repeat(3, 1fr); gap: 24px; margin-bottom: 32px; }
.mode-card { background: var(--background); border: 2px solid var(--border); border-radius: var(--radius-xl); padding: 28px; cursor: pointer; transition: all 0.2s; position: relative; }
.mode-card:hover { border-color: var(--primary-300); box-shadow: var(--shadow-md); }
.mode-card--active { border-color: var(--primary-500); background: var(--primary-50); }
.mode-card__check { position: absolute; top: 16px; right: 16px; width: 24px; height: 24px; border: 2px solid var(--border); border-radius: var(--radius-full); display: flex; align-items: center; justify-content: center; color: white; transition: all 0.2s; }
.mode-card--active .mode-card__check { background: var(--primary-600); border-color: var(--primary-600); }
.mode-card__icon { width: 48px; height: 48px; border-radius: var(--radius-lg); display: flex; align-items: center; justify-content: center; margin-bottom: 16px; }
.mode-card__icon--simple { background: var(--info-light); color: var(--info); }
.mode-card__icon--advanced { background: var(--primary-100); color: var(--primary-600); }
.mode-card__icon--compare { background: #fef3c7; color: #d97706; }
.mode-card__title { font-size: 16px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px; }
.mode-card__desc { font-size: 13px; color: var(--text-secondary); line-height: 1.6; margin-bottom: 16px; }
.mode-card__features { display: flex; flex-direction: column; gap: 8px; }
.mode-card__feature { display: flex; align-items: center; gap: 8px; font-size: 12px; color: var(--text-secondary); }
.mode-card__feature-icon { width: 16px; height: 16px; color: var(--success); }

/* Stats Summary Bar */
.stats-summary { display: flex; align-items: center; justify-content: center; gap: 32px; padding: 16px 24px; background: linear-gradient(135deg, var(--primary-50), var(--surface)); border: 1px solid var(--primary-100); border-radius: var(--radius-lg); margin-bottom: 24px; }
.stats-summary__item { display: flex; align-items: center; gap: 10px; }
.stats-summary__icon { width: 36px; height: 36px; border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; }
.stats-summary__icon--files { background: var(--info-light); color: var(--info); }
.stats-summary__icon--chunks { background: var(--primary-100); color: var(--primary-600); }
.stats-summary__icon--ready { background: var(--success-light); color: var(--success); }
.stats-summary__icon--processing { background: var(--warning-light); color: var(--warning); }
.stats-summary__icon--failed { background: var(--error-light); color: var(--error); }
.stats-summary__info { display: flex; flex-direction: column; }
.stats-summary__value { font-size: 18px; font-weight: 700; color: var(--text-primary); }
.stats-summary__label { font-size: 12px; color: var(--text-secondary); }

/* Simple Upload Mode */
.simple-upload { max-width: 700px; margin: 0 auto; display: none; }
.simple-upload--active { display: block; }
.simple-upload__back { display: flex; align-items: center; gap: 6px; font-size: 13px; color: var(--text-secondary); cursor: pointer; margin-bottom: 24px; padding: 8px 0; }
.simple-upload__back:hover { color: var(--primary-600); }

.upload-zone { border: 2px dashed var(--border); border-radius: var(--radius-xl); padding: 48px 32px; text-align: center; cursor: pointer; transition: all 0.2s; background: var(--background); }
.upload-zone:hover { border-color: var(--primary-300); background: var(--primary-50); }
.upload-zone--dragover { border-color: var(--primary-500); background: var(--primary-100); }
.upload-zone__icon { width: 56px; height: 56px; border-radius: var(--radius-lg); background: var(--primary-100); color: var(--primary-600); display: flex; align-items: center; justify-content: center; margin: 0 auto 16px; }
.upload-zone__title { font-size: 16px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px; }
.upload-zone__desc { font-size: 13px; color: var(--text-secondary); margin-bottom: 4px; }
.upload-zone__formats { font-size: 12px; color: var(--text-tertiary); }

.upload-progress { margin-top: 24px; }
.upload-progress__item { display: flex; align-items: center; gap: 12px; padding: 12px 16px; background: var(--background); border: 1px solid var(--border); border-radius: var(--radius-md); margin-bottom: 8px; }
.upload-progress__icon { width: 36px; height: 36px; border-radius: var(--radius-md); background: var(--info-light); color: var(--info); display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
.upload-progress__info { flex: 1; min-width: 0; }
.upload-progress__name { font-size: 13px; font-weight: 500; color: var(--text-primary); margin-bottom: 6px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.upload-progress__bar { height: 4px; background: var(--gray-200); border-radius: var(--radius-full); overflow: hidden; }
.upload-progress__fill { height: 100%; background: var(--primary-600); border-radius: var(--radius-full); transition: width 0.3s; }
.upload-progress__status { font-size: 12px; color: var(--text-secondary); flex-shrink: 0; }

/* Advanced Mode - Stepper */
.advanced-mode { max-width: 800px; margin: 0 auto; display: none; }
.advanced-mode--active { display: block; }
.advanced-mode__back { display: flex; align-items: center; gap: 6px; font-size: 13px; color: var(--text-secondary); cursor: pointer; margin-bottom: 24px; padding: 8px 0; }
.advanced-mode__back:hover { color: var(--primary-600); }

.stepper { display: flex; align-items: center; justify-content: center; gap: 0; margin-bottom: 40px; padding: 0 20px; }
.stepper__step { display: flex; flex-direction: column; align-items: center; gap: 8px; position: relative; z-index: 1; }
.stepper__circle { width: 36px; height: 36px; border-radius: var(--radius-full); border: 2px solid var(--border); background: var(--background); display: flex; align-items: center; justify-content: center; font-size: 13px; font-weight: 600; color: var(--text-tertiary); transition: all 0.3s; }
.stepper__circle--active { border-color: var(--primary-600); background: var(--primary-600); color: white; }
.stepper__circle--completed { border-color: var(--success); background: var(--success); color: white; }
.stepper__label { font-size: 12px; color: var(--text-tertiary); font-weight: 500; white-space: nowrap; }
.stepper__label--active { color: var(--primary-600); font-weight: 600; }
.stepper__line { width: 80px; height: 2px; background: var(--border); margin: 0 8px; margin-bottom: 28px; }
.stepper__line--completed { background: var(--success); }

/* Step Content */
.step { display: none; }
.step--active { display: block; }
.step--active { display: block; }
.step-card { background: var(--background); border: 1px solid var(--border); border-radius: var(--radius-xl); padding: 32px; }
.step-card__header { margin-bottom: 24px; }
.step-card__title { font-size: 18px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px; }
.step-card__desc { font-size: 14px; color: var(--text-secondary); }

.step-actions { display: flex; justify-content: space-between; margin-top: 32px; padding-top: 24px; border-top: 1px solid var(--border); }

/* Form Elements */
.form-group { margin-bottom: 24px; }
.form-label { display: block; font-size: 13px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px; }
.form-label__hint { font-weight: 400; color: var(--text-tertiary); }
.form-hint { font-size: 12px; color: var(--text-tertiary); margin-top: 6px; }
.form-input { width: 100%; padding: 10px 14px; border: 1px solid var(--border); border-radius: var(--radius-md); font-size: 14px; color: var(--text-primary); transition: all 0.2s; }
.form-input:focus { outline: none; border-color: var(--primary-500); box-shadow: 0 0 0 3px var(--primary-100); }
.form-select { width: 100%; padding: 10px 14px; border: 1px solid var(--border); border-radius: var(--radius-md); font-size: 14px; color: var(--text-primary); background: var(--background); cursor: pointer; transition: all 0.2s; }
.form-select:focus { outline: none; border-color: var(--primary-500); box-shadow: 0 0 0 3px var(--primary-100); }
.form-row { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; }

/* Option Cards */
.option-cards { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
.option-card { padding: 16px; border: 1px solid var(--border); border-radius: var(--radius-lg); cursor: pointer; transition: all 0.2s; }
.option-card:hover { border-color: var(--primary-300); }
.option-card--active { border-color: var(--primary-500); background: var(--primary-50); }
.option-card__header { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
.option-card__icon { width: 32px; height: 32px; border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; }
.option-card__icon--blue { background: var(--info-light); color: var(--info); }
.option-card__icon--purple { background: var(--primary-100); color: var(--primary-600); }
.option-card__title { font-size: 14px; font-weight: 600; color: var(--text-primary); }
.option-card__badge { font-size: 10px; font-weight: 600; padding: 2px 8px; border-radius: var(--radius-full); background: var(--success); color: white; }
.option-card__desc { font-size: 12px; color: var(--text-secondary); line-height: 1.5; }

/* Checkbox */
.checkbox-group { display: flex; flex-direction: column; gap: 10px; }
.checkbox-item { display: flex; align-items: center; gap: 10px; cursor: pointer; }
.checkbox-item input { width: 18px; height: 18px; accent-color: var(--primary-600); cursor: pointer; }
.checkbox-item__label { font-size: 13px; color: var(--text-secondary); }

/* Slider */
.slider-group { display: flex; align-items: center; gap: 16px; }
.slider-input { flex: 1; height: 6px; border-radius: var(--radius-full); -webkit-appearance: none; background: var(--gray-200); }
.slider-input::-webkit-slider-thumb { -webkit-appearance: none; width: 18px; height: 18px; border-radius: var(--radius-full); background: var(--primary-600); cursor: pointer; }
.slider-value { min-width: 60px; text-align: right; font-size: 13px; font-weight: 600; color: var(--text-primary); }

/* Preview Section */
.preview-section { margin-top: 24px; }
.preview-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
.preview-title { font-size: 14px; font-weight: 600; color: var(--text-primary); }
.preview-box { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 16px; max-height: 200px; overflow-y: auto; }
.preview-chunk { padding: 12px; background: var(--background); border: 1px solid var(--border); border-radius: var(--radius-md); margin-bottom: 8px; font-size: 13px; color: var(--text-secondary); line-height: 1.6; }
.preview-chunk:last-child { margin-bottom: 0; }
.preview-chunk__header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; font-size: 11px; }
.preview-chunk__id { font-weight: 600; color: var(--primary-600); }
.preview-chunk__size { color: var(--text-tertiary); }

/* ========== Split Preview Layout ========== */
.step-card--split { display: flex; gap: 0; padding: 0; overflow: hidden; }
.step-card--split .step-card__settings { flex: 1; padding: 32px; border-right: 1px solid var(--border); overflow-y: auto; max-height: 70vh; }
.step-card--split .step-card__preview { width: 420px; display: flex; flex-direction: column; background: var(--surface); flex-shrink: 0; }
.step-card__preview-header { padding: 16px 20px; background: var(--background); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
.step-card__preview-title { font-size: 14px; font-weight: 600; color: var(--text-primary); display: flex; align-items: center; gap: 8px; }
.step-card__preview-title svg { color: var(--primary-600); }
.step-card__preview-close { width: 28px; height: 28px; border: 1px solid var(--border); background: var(--background); border-radius: var(--radius-md); cursor: pointer; color: var(--text-tertiary); display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
.step-card__preview-close:hover { border-color: var(--error); color: var(--error); background: var(--error-light); }
.step-card__preview-body { flex: 1; padding: 20px; overflow-y: auto; }
.step-card__preview-stats { display: flex; gap: 12px; margin-bottom: 16px; }
.preview-stat { flex: 1; background: var(--background); border: 1px solid var(--border); border-radius: var(--radius-md); padding: 12px; text-align: center; }
.preview-stat__value { font-size: 20px; font-weight: 700; color: var(--primary-600); }
.preview-stat__label { font-size: 11px; color: var(--text-tertiary); margin-top: 2px; }
.step-card__preview-list { display: flex; flex-direction: column; gap: 0; }

/* 문서형 프리뷰 스타일 */
.doc-preview { background: var(--background); border: 1px solid var(--border); border-radius: var(--radius-lg); overflow: hidden; }
.doc-preview__chunk { padding: 16px; font-size: 13px; line-height: 1.8; color: var(--text-primary); position: relative; }
.doc-preview__chunk:not(:last-child) { border-bottom: 2px dashed var(--primary-300); }
.doc-preview__chunk::before { content: attr(data-label); position: absolute; top: 0; right: 0; background: var(--primary-100); color: var(--primary-600); font-size: 10px; font-weight: 600; padding: 4px 10px; border-radius: 0 0 0 var(--radius-md); }
.doc-preview__chunk--even { background: var(--gray-50); }
.doc-preview__divider { display: flex; align-items: center; gap: 12px; padding: 8px 16px; background: linear-gradient(90deg, var(--primary-50), transparent); border-top: 1px solid var(--primary-200); border-bottom: 1px solid var(--primary-200); }
.doc-preview__divider-icon { width: 20px; height: 20px; background: var(--primary-600); color: white; border-radius: var(--radius-full); display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 700; }
.doc-preview__divider-info { font-size: 11px; color: var(--primary-600); font-weight: 500; }
.doc-preview__divider-meta { margin-left: auto; font-size: 10px; color: var(--text-tertiary); }

/* 부모-자식 문서형 스타일 */
.doc-preview__parent { background: linear-gradient(135deg, #eff6ff, #f8faff); border-left: 3px solid #3b82f6; }
.doc-preview__parent::before { background: #dbeafe; color: #2563eb; }
.doc-preview__parent-divider { background: linear-gradient(90deg, #dbeafe, transparent); border-color: #93c5fd; }
.doc-preview__parent-divider .doc-preview__divider-icon { background: #3b82f6; }
.doc-preview__parent-divider .doc-preview__divider-info { color: #2563eb; }
.doc-preview__child-section { margin: 12px 16px; padding: 0; background: transparent; }
.doc-preview__child { background: linear-gradient(135deg, #fffbeb, #fffef5); border-left: 2px solid #f59e0b; margin-bottom: 8px; border-radius: var(--radius-md); padding: 12px; font-size: 12px; position: relative; }
.doc-preview__child::before { content: attr(data-label); position: absolute; top: 4px; right: 4px; background: #fef3c7; color: #d97706; font-size: 9px; font-weight: 600; padding: 2px 8px; border-radius: var(--radius-sm); }
.doc-preview__child:last-child { margin-bottom: 0; }
.doc-preview__child-divider { display: flex; align-items: center; gap: 8px; padding: 6px 12px; background: #fef3c7; border-radius: var(--radius-sm); margin-bottom: 8px; }
.doc-preview__child-divider-icon { width: 16px; height: 16px; background: #f59e0b; color: white; border-radius: var(--radius-full); display: flex; align-items: center; justify-content: center; }
.doc-preview__child-divider-icon svg { width: 10px; height: 10px; }
.doc-preview__child-divider-info { font-size: 10px; color: #d97706; font-weight: 500; }

/* 중첩 표시 */
.doc-preview__overlap { background: linear-gradient(90deg, var(--warning-light), transparent); padding: 2px 8px; font-size: 10px; color: var(--warning); border-radius: var(--radius-sm); display: inline-block; margin-top: 8px; }
.preview-chunk--split { padding: 14px; background: var(--background); border: 1px solid var(--border); border-radius: var(--radius-lg); transition: all 0.2s; }
.preview-chunk--split:hover { border-color: var(--primary-300); box-shadow: var(--shadow-sm); }
.preview-chunk__number { display: inline-flex; align-items: center; justify-content: center; width: 24px; height: 24px; background: var(--primary-100); color: var(--primary-600); font-size: 11px; font-weight: 700; border-radius: var(--radius-full); margin-right: 8px; }
.preview-chunk__text { font-size: 13px; color: var(--text-secondary); line-height: 1.6; margin-top: 10px; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
.preview-chunk__meta { display: flex; align-items: center; gap: 12px; margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border); }
.preview-chunk__meta-item { font-size: 11px; color: var(--text-tertiary); display: flex; align-items: center; gap: 4px; }
.preview-chunk__meta-item svg { width: 12px; height: 12px; }
.step-card__preview-empty { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 200px; text-align: center; color: var(--text-tertiary); }
.step-card__preview-empty svg { width: 48px; height: 48px; margin-bottom: 12px; opacity: 0.5; }
.step-card__preview-empty-text { font-size: 13px; }
.step-card__preview-footer { padding: 16px 20px; background: var(--background); border-top: 1px solid var(--border); }
.preview-refresh-btn { width: 100%; display: flex; align-items: center; justify-content: center; gap: 8px; padding: 10px; border: 1px solid var(--primary-300); background: var(--primary-50); border-radius: var(--radius-md); font-size: 13px; font-weight: 500; color: var(--primary-600); cursor: pointer; transition: all 0.2s; }
.preview-refresh-btn:hover { background: var(--primary-100); border-color: var(--primary-400); }
.preview-refresh-btn svg { width: 16px; height: 16px; }
.preview-refresh-btn--loading svg { animation: spin 1s linear infinite; }

/* Split view 버튼 상태 */
.btn--preview-active { background: var(--primary-600); border-color: var(--primary-600); color: white; }
.btn--preview-active:hover { background: var(--primary-700); }

/* advanced-mode width 확장 for split view */
.advanced-mode--split { max-width: 1200px; }

@media (max-width: 1024px) {
    .step-card--split { flex-direction: column; }
    .step-card--split .step-card__preview { width: 100%; max-height: 400px; }
    .step-card--split .step-card__settings { max-height: none; border-right: none; border-bottom: 1px solid var(--border); }
}

/* Summary Card */
.summary-card { background: var(--background); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 20px; margin-bottom: 16px; }
.summary-card__title { font-size: 14px; font-weight: 600; color: var(--text-primary); margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
.summary-card__title-icon { width: 20px; height: 20px; color: var(--primary-600); }
.summary-list { display: grid; gap: 12px; }
.summary-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--border); }
.summary-item:last-child { border-bottom: none; }
.summary-item__label { font-size: 13px; color: var(--text-secondary); }
.summary-item__value { font-size: 13px; font-weight: 600; color: var(--text-primary); }

/* File List Section */
.file-list-section { margin-top: 40px; padding-top: 32px; border-top: 1px solid var(--border); }
.file-list-section .stats-summary { margin-top: 16px; margin-bottom: 24px; }
.file-list-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 0; }
.file-list-title { font-size: 16px; font-weight: 600; color: var(--text-primary); }
.file-list-count { font-size: 13px; color: var(--text-tertiary); background: var(--gray-100); padding: 4px 10px; border-radius: var(--radius-full); }

/* File List Toolbar */
.file-list-toolbar { display: flex; align-items: center; gap: 12px; margin-top: 20px; margin-bottom: 20px; flex-wrap: wrap; }
.file-search { flex: 1; min-width: 200px; max-width: 320px; position: relative; }
.file-search__input { width: 100%; padding: 9px 14px 9px 38px; border: 1px solid var(--border); border-radius: var(--radius-md); font-size: 13px; color: var(--text-primary); background: var(--background); transition: all 0.2s; }
.file-search__input:focus { outline: none; border-color: var(--primary-400); box-shadow: 0 0 0 3px var(--primary-100); }
.file-search__input::placeholder { color: var(--text-tertiary); }
.file-search__icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-tertiary); pointer-events: none; }

.file-filter { position: relative; }
.file-filter__button { display: flex; align-items: center; gap: 8px; padding: 9px 14px; border: 1px solid var(--border); border-radius: var(--radius-md); background: var(--background); font-size: 13px; color: var(--text-primary); cursor: pointer; transition: all 0.2s; white-space: nowrap; }
.file-filter__button:hover { border-color: var(--primary-300); background: var(--surface); }
.file-filter__button.active { border-color: var(--primary-500); background: var(--primary-50); }
.file-filter__arrow { color: var(--text-tertiary); transition: transform 0.2s; }
.file-filter__button.active .file-filter__arrow { transform: rotate(180deg); }
.file-filter__dropdown { position: absolute; top: calc(100% + 4px); left: 0; min-width: 160px; background: var(--background); border: 1px solid var(--border); border-radius: var(--radius-md); box-shadow: var(--shadow-lg); z-index: 100; opacity: 0; visibility: hidden; transform: translateY(-4px); transition: all 0.2s; }
.file-filter__dropdown.show { opacity: 1; visibility: visible; transform: translateY(0); }
.file-filter__item { display: flex; align-items: center; gap: 8px; padding: 10px 14px; font-size: 13px; color: var(--text-secondary); cursor: pointer; transition: all 0.2s; }
.file-filter__item:first-child { border-radius: var(--radius-md) var(--radius-md) 0 0; }
.file-filter__item:last-child { border-radius: 0 0 var(--radius-md) var(--radius-md); }
.file-filter__item:hover { background: var(--surface); color: var(--text-primary); }
.file-filter__item.selected { background: var(--primary-50); color: var(--primary-600); font-weight: 500; }
.file-filter__check { width: 16px; height: 16px; opacity: 0; }
.file-filter__item.selected .file-filter__check { opacity: 1; color: var(--primary-600); }

.file-view-toggle { display: flex; border: 1px solid var(--border); border-radius: var(--radius-md); overflow: hidden; margin-left: auto; }
.file-view-toggle__btn { width: 36px; height: 36px; border: none; background: var(--background); cursor: pointer; color: var(--text-tertiary); display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
.file-view-toggle__btn:first-child { border-right: 1px solid var(--border); }
.file-view-toggle__btn:hover { background: var(--surface); color: var(--text-primary); }
.file-view-toggle__btn.active { background: var(--primary-50); color: var(--primary-600); }

.file-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 16px; }
.file-grid.file-grid--list { grid-template-columns: 1fr; gap: 6px; }
.file-grid--list .file-card { display: flex; align-items: center; padding: 10px 16px; }
.file-grid--list .file-card__header { margin-bottom: 0; flex: 1; }
.file-grid--list .file-card__icon { width: 32px; height: 32px; }
.file-grid--list .file-card__name { font-size: 13px; }
.file-grid--list .file-card__meta { font-size: 11px; }
.file-grid--list .file-card__status { margin-left: auto; font-size: 10px; padding: 3px 8px; }
.file-grid--list .file-card__footer { border-top: none; padding-top: 0; margin-left: 12px; flex-shrink: 0; }
.file-grid--list .file-card__chunks { font-size: 11px; }

.file-card { background: var(--background); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 16px; transition: all 0.2s; position: relative; }
.file-card:hover { border-color: var(--primary-300); box-shadow: var(--shadow-sm); }
.file-card.selected { border-color: var(--primary-500); background: var(--primary-50); }

/* Custom Checkbox */
.file-card__checkbox { position: absolute; top: 12px; right: 12px; width: 20px; height: 20px; appearance: none; -webkit-appearance: none; border: 2px solid var(--gray-300); border-radius: var(--radius-sm); cursor: pointer; transition: all 0.2s; background: var(--background); }
.file-card__checkbox:hover { border-color: var(--primary-400); }
.file-card__checkbox:checked { background: var(--primary-600); border-color: var(--primary-600); }
.file-card__checkbox:checked::after { content: ''; position: absolute; left: 6px; top: 2px; width: 5px; height: 10px; border: solid white; border-width: 0 2px 2px 0; transform: rotate(45deg); }

.file-card__header { display: flex; align-items: flex-start; gap: 12px; margin-bottom: 12px; }
.file-card__icon { width: 40px; height: 40px; border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
.file-card__icon--pdf { background: #fee2e2; color: #ef4444; }
.file-card__icon--docx { background: #dbeafe; color: #3b82f6; }
.file-card__icon--txt { background: var(--gray-100); color: var(--gray-600); }
.file-card__icon--csv { background: #d1fae5; color: #10b981; }
.file-card__info { flex: 1; min-width: 0; padding-right: 28px; }
.file-card__name { font-size: 14px; font-weight: 500; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 4px; }
.file-card__meta { font-size: 12px; color: var(--text-tertiary); }
.file-card__status { display: inline-flex; align-items: center; gap: 4px; font-size: 11px; font-weight: 500; padding: 4px 8px; border-radius: var(--radius-full); }
.file-card__status--ready { background: var(--success-light); color: var(--success); }
.file-card__status--failed { background: var(--error-light); color: var(--error); }
.file-card__footer { display: flex; align-items: center; justify-content: space-between; padding-top: 12px; border-top: 1px solid var(--border); }
.file-card__chunks { font-size: 12px; color: var(--text-secondary); }

/* Selection Actions Bar */
.selection-bar { display: flex; align-items: center; gap: 16px; padding: 12px 16px; background: var(--primary-50); border: 1px solid var(--primary-200); border-radius: var(--radius-md); margin-bottom: 16px; }
.selection-bar.hidden { display: none; }
.selection-bar__checkbox { display: flex; align-items: center; gap: 8px; cursor: pointer; }
.selection-bar__checkbox input { width: 18px; height: 18px; appearance: none; -webkit-appearance: none; border: 2px solid var(--primary-400); border-radius: var(--radius-sm); cursor: pointer; transition: all 0.2s; background: var(--background); position: relative; }
.selection-bar__checkbox input:checked { background: var(--primary-600); border-color: var(--primary-600); }
.selection-bar__checkbox input:checked::after { content: ''; position: absolute; left: 5px; top: 1px; width: 5px; height: 10px; border: solid white; border-width: 0 2px 2px 0; transform: rotate(45deg); }
.selection-bar__checkbox-label { font-size: 13px; font-weight: 500; color: var(--text-primary); }
.selection-bar__count { font-size: 13px; color: var(--primary-600); font-weight: 500; }
.selection-bar__actions { margin-left: auto; display: flex; gap: 8px; }
.selection-bar__btn { display: flex; align-items: center; gap: 6px; padding: 8px 14px; border: none; border-radius: var(--radius-md); font-size: 13px; font-weight: 500; cursor: pointer; transition: all 0.2s; }
.selection-bar__btn--delete { background: var(--error); color: white; }
.selection-bar__btn--delete:hover { background: #dc2626; }
.selection-bar__btn--cancel { background: var(--background); border: 1px solid var(--border); color: var(--text-secondary); }
.selection-bar__btn--cancel:hover { background: var(--surface); color: var(--text-primary); }

/* List view - checkbox on left side */
.file-grid--list .file-card { display: flex; align-items: center; padding: 12px 16px; gap: 12px; }
.file-grid--list .file-card__checkbox { position: relative; top: auto; right: auto; flex-shrink: 0; order: -1; }
.file-grid--list .file-card__header { margin-bottom: 0; flex: 1; min-width: 0; }
.file-grid--list .file-card__info { padding-right: 0; }
.file-grid--list .file-card__icon { width: 32px; height: 32px; }
.file-grid--list .file-card__name { font-size: 13px; }
.file-grid--list .file-card__footer { border-top: none; padding-top: 0; flex-shrink: 0; }

/* Pagination */
.pagination { display: flex; align-items: center; justify-content: center; gap: 4px; margin-top: 24px; padding-top: 20px; border-top: 1px solid var(--border); }
#pageNumbers { display: flex; align-items: center; gap: 4px; }
.pagination__btn { min-width: 36px; height: 36px; padding: 0 12px; border: 1px solid var(--border); background: var(--background); border-radius: var(--radius-md); font-size: 13px; font-weight: 500; color: var(--text-secondary); cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; transition: all 0.2s; }
.pagination__btn:hover:not(:disabled) { border-color: var(--primary-300); color: var(--primary-600); background: var(--primary-50); }
.pagination__btn:disabled { opacity: 0.5; cursor: not-allowed; }
.pagination__btn--active { background: var(--primary-600); border-color: var(--primary-600); color: white; }
.pagination__btn--active:hover { background: var(--primary-700); border-color: var(--primary-700); color: white; }
.pagination__ellipsis { padding: 0 8px; color: var(--text-tertiary); font-size: 13px; }
.pagination__info { margin-left: 16px; font-size: 12px; color: var(--text-tertiary); }

/* Empty State */
.empty-state { text-align: center; padding: 60px 20px; }
.empty-state__icon { width: 64px; height: 64px; margin: 0 auto 16px; background: var(--primary-50); border-radius: var(--radius-xl); display: flex; align-items: center; justify-content: center; color: var(--primary-400); }
.empty-state__title { font-size: 16px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px; }
.empty-state__desc { font-size: 14px; color: var(--text-tertiary); }

/* Toast */
.toast { position: fixed; bottom: 24px; right: 24px; display: flex; align-items: center; gap: 12px; padding: 14px 18px; background: var(--gray-800); color: white; border-radius: var(--radius-lg); box-shadow: var(--shadow-lg); z-index: 10001; animation: slideIn 0.3s ease-out; }
.toast--success { background: var(--success); }
.toast--error { background: var(--error); }
.toast--warning { background: var(--warning); }
.toast--info { background: var(--info); }
@keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
@keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
@keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

/* ========== Back Button ========== */
.compare-mode { display: none; padding: 24px 32px; flex: 1; overflow-y: auto; }
.compare-mode.active { display: block; }
.compare-mode__back { display: flex; align-items: center; gap: 8px; color: var(--text-secondary); font-size: 14px; cursor: pointer; margin-bottom: 24px; padding: 8px 0; background: none; border: none; }
.compare-mode__back:hover { color: var(--primary-600); }

/* ========== Header Section ========== */
.compare-header { background: var(--background); border: 1px solid var(--border); border-radius: var(--radius-xl); padding: 20px 24px; margin-bottom: 24px; display: flex; align-items: center; justify-content: space-between; max-width: 1600px; margin-left: auto; margin-right: auto; }
.compare-header__left { display: flex; align-items: center; gap: 12px; }
.compare-header__icon { width: 40px; height: 40px; background: #fef3c7; border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; color: #d97706; }
.compare-header__title { font-size: 18px; font-weight: 600; color: var(--text-primary); }
.compare-header__desc { font-size: 13px; color: var(--text-secondary); margin-top: 2px; }

/* Model Selector */
.model-selector { display: flex; align-items: center; gap: 10px; }
.model-selector__label { font-size: 13px; color: var(--text-secondary); }
.model-selector__dropdown { position: relative; }
.model-selector__button { display: flex; align-items: center; gap: 8px; padding: 8px 14px; background: var(--background); border: 1px solid var(--border); border-radius: var(--radius-md); cursor: pointer; transition: all 0.2s; min-width: 150px; font-size: 13px; }
.model-selector__button:hover { border-color: var(--primary-300); }
.model-selector__button.active { border-color: var(--primary-500); }
.model-selector__dot { width: 8px; height: 8px; border-radius: var(--radius-full); }
.model-selector__dot--gpt { background: var(--gpt-color); }
.model-selector__dot--claude { background: var(--claude-color); }
.model-selector__dot--gemini { background: var(--gemini-color); }
.model-selector__name { font-weight: 500; color: var(--text-primary); flex: 1; }
.model-selector__arrow { color: var(--text-tertiary); transition: transform 0.2s; }
.model-selector__button.active .model-selector__arrow { transform: rotate(180deg); }

.model-dropdown { position: absolute; top: calc(100% + 4px); left: 0; right: 0; background: var(--background); border: 1px solid var(--border); border-radius: var(--radius-md); box-shadow: var(--shadow-lg); z-index: 100; opacity: 0; visibility: hidden; transform: translateY(-4px); transition: all 0.2s; }
.model-dropdown.show { opacity: 1; visibility: visible; transform: translateY(0); }
.model-dropdown__item { display: flex; align-items: center; gap: 8px; padding: 10px 14px; cursor: pointer; transition: background 0.2s; font-size: 13px; }
.model-dropdown__item:first-child { border-radius: var(--radius-md) var(--radius-md) 0 0; }
.model-dropdown__item:last-child { border-radius: 0 0 var(--radius-md) var(--radius-md); }
.model-dropdown__item:hover { background: var(--gray-50); }
.model-dropdown__item.selected { background: var(--primary-50); }

/* ========== Compare Panels ========== */
.compare-panels { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; max-width: 1600px; margin: 0 auto; }
@media (max-width: 1024px) { .compare-panels { grid-template-columns: 1fr; } }

.compare-panel { background: var(--background); border: 1px solid var(--border); border-radius: var(--radius-xl); overflow: hidden; }
.compare-panel__header { padding: 16px 20px; background: var(--surface); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
.compare-panel__title { font-size: 15px; font-weight: 600; color: var(--text-primary); display: flex; align-items: center; gap: 8px; }
.compare-panel__badge { font-size: 11px; font-weight: 600; padding: 4px 10px; border-radius: var(--radius-full); }
.compare-panel__badge--a { background: var(--info-light); color: var(--info); }
.compare-panel__badge--b { background: #fef3c7; color: #d97706; }

/* Mode Status Badge */
.mode-status { font-size: 11px; font-weight: 500; padding: 4px 10px; border-radius: var(--radius-full); }
.mode-status--llm { background: var(--gray-100); color: var(--text-secondary); }
.mode-status--doc { background: var(--info-light); color: var(--info); }
.mode-status--rag { background: var(--success-light); color: var(--success); }

/* Panel Actions */
.compare-panel__actions { display: flex; align-items: center; gap: 8px; }
.panel-reset-btn { width: 28px; height: 28px; border: 1px solid var(--border); background: var(--background); border-radius: var(--radius-md); cursor: pointer; color: var(--text-tertiary); display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
.panel-reset-btn:hover { border-color: var(--primary-300); color: var(--primary-600); background: var(--primary-50); }

.compare-panel__body { padding: 20px; }

/* Mode Selector */
.mode-selector { display: flex; gap: 8px; margin-bottom: 20px; }
.mode-selector__item { flex: 1; padding: 12px; border: 1px solid var(--border); border-radius: var(--radius-md); cursor: pointer; transition: all 0.2s; text-align: center; }
.mode-selector__item:hover { border-color: var(--primary-300); }
.mode-selector__item.active { border-color: var(--primary-500); background: var(--primary-50); }
.mode-selector__icon { width: 32px; height: 32px; border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; margin: 0 auto 8px; }
.mode-selector__icon--llm { background: var(--gray-100); color: var(--text-tertiary); }
.mode-selector__icon--doc { background: var(--info-light); color: var(--info); }
.mode-selector__icon--rag { background: var(--success-light); color: var(--success); }
.mode-selector__label { font-size: 12px; font-weight: 600; color: var(--text-primary); margin-bottom: 2px; }
.mode-selector__desc { font-size: 10px; color: var(--text-tertiary); line-height: 1.4; }

/* Mode Content */
.mode-content { display: none; }
.mode-content.show { display: block; }

/* LLM Only State */
.llm-state { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 32px 24px; text-align: center; background: var(--gray-50); border-radius: var(--radius-lg); border: 1px dashed var(--border); }
.llm-state__icon { width: 48px; height: 48px; background: var(--background); border-radius: var(--radius-lg); display: flex; align-items: center; justify-content: center; margin-bottom: 12px; border: 1px solid var(--border); color: var(--text-tertiary); }
.llm-state__title { font-size: 14px; font-weight: 600; color: var(--text-primary); margin-bottom: 4px; }
.llm-state__text { font-size: 12px; color: var(--text-secondary); line-height: 1.5; }

/* Document Selector */
.doc-selector { margin-bottom: 16px; }
.doc-selector__label { font-size: 12px; font-weight: 600; color: var(--text-secondary); margin-bottom: 8px; display: flex; align-items: center; gap: 6px; }
.doc-selector__dropdown { position: relative; }
.doc-selector__button { width: 100%; display: flex; align-items: center; gap: 10px; padding: 12px 14px; background: var(--background); border: 1px solid var(--border); border-radius: var(--radius-md); cursor: pointer; transition: all 0.2s; }
.doc-selector__button:hover { border-color: var(--primary-300); }
.doc-selector__button.active { border-color: var(--primary-500); }
.doc-selector__icon { width: 32px; height: 32px; border-radius: var(--radius-md); background: var(--info-light); color: var(--info); display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
.doc-selector__info { flex: 1; text-align: left; }
.doc-selector__name { font-size: 13px; font-weight: 500; color: var(--text-primary); }
.doc-selector__meta { font-size: 11px; color: var(--text-tertiary); margin-top: 2px; }
.doc-selector__arrow { color: var(--text-tertiary); transition: transform 0.2s; }
.doc-selector__button.active .doc-selector__arrow { transform: rotate(180deg); }
.doc-selector__placeholder { color: var(--text-tertiary); font-size: 13px; }

.doc-dropdown { position: absolute; top: calc(100% + 4px); left: 0; right: 0; background: var(--background); border: 1px solid var(--border); border-radius: var(--radius-md); box-shadow: var(--shadow-lg); z-index: 100; opacity: 0; visibility: hidden; transform: translateY(-4px); transition: all 0.2s; }
.doc-dropdown.show { opacity: 1; visibility: visible; transform: translateY(0); }
.doc-dropdown__search { padding: 8px; border-bottom: 1px solid var(--border); }
.doc-dropdown__search-input { width: 100%; padding: 8px 10px 8px 32px; border: 1px solid var(--border); border-radius: var(--radius-md); font-size: 12px; background: var(--surface) url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%2394a3b8' stroke-width='2'%3E%3Ccircle cx='11' cy='11' r='8'/%3E%3Cpath d='m21 21-4.35-4.35'/%3E%3C/svg%3E") 10px center no-repeat; }
.doc-dropdown__search-input:focus { outline: none; border-color: var(--primary-400); }
.doc-dropdown__list { max-height: 200px; overflow-y: auto; }
.doc-dropdown__item { display: flex; align-items: center; gap: 10px; padding: 10px 14px; cursor: pointer; transition: background 0.2s; }
.doc-dropdown__item:hover { background: var(--gray-50); }
.doc-dropdown__item.selected { background: var(--primary-50); }
.doc-dropdown__item.hidden { display: none; }
.doc-dropdown__item-icon { width: 28px; height: 28px; border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
.doc-dropdown__item-icon--pdf { background: #fee2e2; color: #ef4444; }
.doc-dropdown__item-icon--txt { background: var(--gray-100); color: var(--gray-600); }
.doc-dropdown__item-icon--csv { background: #d1fae5; color: #10b981; }
.doc-dropdown__item-info { flex: 1; }
.doc-dropdown__item-name { font-size: 13px; font-weight: 500; color: var(--text-primary); }
.doc-dropdown__item-meta { font-size: 11px; color: var(--text-tertiary); margin-top: 1px; }
.doc-dropdown__empty { padding: 20px; text-align: center; color: var(--text-tertiary); font-size: 13px; }

/* Default Settings Info */
.default-settings { padding: 12px 14px; background: var(--info-light); border-radius: var(--radius-md); margin-bottom: 16px; }
.default-settings__title { font-size: 11px; font-weight: 600; color: var(--info); margin-bottom: 6px; display: flex; align-items: center; gap: 6px; }
.default-settings__grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
.default-settings__item { text-align: center; }
.default-settings__label { font-size: 10px; color: var(--text-tertiary); }
.default-settings__value { font-size: 12px; font-weight: 600; color: var(--info); }

/* Settings Section */
.settings-section { padding: 14px; background: var(--gray-50); border: 1px solid var(--border); border-radius: var(--radius-md); margin-bottom: 16px; }
.settings-section__title { display: flex; align-items: center; gap: 6px; font-size: 12px; font-weight: 600; color: var(--text-primary); margin-bottom: 10px; }
.setting-row { display: flex; align-items: center; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border); }
.setting-row:last-child { border-bottom: none; padding-bottom: 0; }
.setting-row__label { font-size: 11px; color: var(--text-secondary); }
.setting-row__value { font-size: 11px; font-weight: 600; color: var(--primary-600); min-width: 45px; text-align: right; }
.setting-row__slider { display: flex; align-items: center; gap: 8px; }
.setting-row__slider input[type="range"] { width: 90px; height: 4px; -webkit-appearance: none; background: var(--gray-200); border-radius: var(--radius-full); outline: none; }
.setting-row__slider input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 12px; height: 12px; border-radius: var(--radius-full); background: var(--primary-600); cursor: pointer; }

/* Divider */
.section-divider { height: 1px; background: var(--border); margin: 16px 0; }

/* Test Section */
.test-section { }
.test-section__label { font-size: 11px; font-weight: 600; color: var(--text-secondary); margin-bottom: 6px; display: flex; align-items: center; gap: 5px; }
.test-input { width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: var(--radius-md); font-size: 12px; font-family: var(--font-sans); resize: none; transition: all 0.2s; }
.test-input:focus { outline: none; border-color: var(--primary-500); box-shadow: 0 0 0 3px var(--primary-100); }
.test-actions { display: flex; justify-content: flex-end; margin-top: 8px; }

.btn { display: inline-flex; align-items: center; justify-content: center; gap: 5px; padding: 7px 14px; border-radius: var(--radius-md); font-size: 12px; font-weight: 500; cursor: pointer; transition: all 0.2s; border: none; }
.btn--primary { background: var(--primary-600); color: white; }
.btn--primary:hover:not(:disabled) { background: var(--primary-700); }
.btn--primary:disabled { opacity: 0.5; cursor: not-allowed; }

/* Result Box */
.result-box { display: none; margin-top: 16px; }
.result-box.show { display: block; animation: fadeIn 0.3s ease; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

.result-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-lg); overflow: hidden; }
.result-card__header { display: flex; align-items: center; justify-content: space-between; padding: 10px 14px; border-bottom: 1px solid var(--border); }
.result-card__label { font-size: 11px; font-weight: 600; color: var(--text-secondary); }
.result-card__model { display: flex; align-items: center; gap: 4px; font-size: 10px; font-weight: 500; padding: 3px 8px; border-radius: var(--radius-sm); }
.result-card__model--gpt { background: var(--gpt-bg); color: var(--gpt-color); }
.result-card__model--claude { background: var(--claude-bg); color: var(--claude-color); }
.result-card__model--gemini { background: var(--gemini-bg); color: var(--gemini-color); }
.result-card__body { padding: 14px; max-height: 200px; overflow-y: auto; }
.result-card__text { font-size: 12px; color: var(--text-primary); line-height: 1.6; white-space: pre-wrap; }
.result-card__footer { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; padding: 10px 14px; background: var(--gray-50); border-top: 1px solid var(--border); }
.result-card__stat { text-align: center; }
.result-card__stat-value { font-size: 13px; font-weight: 700; color: var(--primary-600); }
.result-card__stat-label { font-size: 9px; color: var(--text-tertiary); margin-top: 1px; }

/* Sync Notice */
.sync-notice { display: flex; align-items: center; gap: 6px; padding: 8px 12px; background: var(--info-light); border-radius: var(--radius-md); margin-bottom: 12px; font-size: 11px; color: var(--info); }

/* Toast */
.toast { position: fixed; bottom: 24px; right: 24px; display: flex; align-items: center; gap: 10px; padding: 12px 18px; background: var(--gray-800); color: white; border-radius: var(--radius-md); box-shadow: var(--shadow-lg); z-index: 10000; animation: slideIn 0.3s ease; font-size: 13px; }
.toast--success { background: var(--success); }
.toast--error { background: var(--error); }
.toast--warning { background: var(--warning); }
@keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

/* Context Menu */
.context-menu { position: fixed; min-width: 180px; background: var(--background); border: 1px solid var(--border); border-radius: var(--radius-lg); box-shadow: var(--shadow-lg); z-index: 9999; padding: 4px; opacity: 0; visibility: hidden; }
.context-menu--open { opacity: 1; visibility: visible; }
.context-menu__item { display: flex; align-items: center; gap: 8px; padding: 8px 12px; font-size: 13px; color: var(--text-primary); cursor: pointer; border-radius: var(--radius-md); transition: background 0.2s; }
.context-menu__item:hover { background: var(--surface); }
.context-menu__item--danger { color: var(--error); }
.context-menu__item--danger:hover { background: #fef2f2; }
.context-menu__item--project-add { color: var(--success); }
.context-menu__item--project-add:hover { background: #ecfdf5; }
.context-menu__item--project-change { color: var(--info); }
.context-menu__item--project-change:hover { background: #eff6ff; }
.context-menu__item--project-remove { color: var(--warning); }
.context-menu__item--project-remove:hover { background: #fffbeb; }
.context-menu__divider { height: 1px; background: var(--border); margin: 4px 0; }

/* Modal */
.modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 9999; opacity: 0; visibility: hidden; transition: all 0.2s; }
.modal-overlay--open { opacity: 1; visibility: visible; }
.modal { background: var(--background); border-radius: var(--radius-xl); box-shadow: var(--shadow-lg); width: 100%; max-width: 520px; max-height: 90vh; overflow: hidden; transform: scale(0.95); transition: transform 0.2s; }
.modal-overlay--open .modal { transform: scale(1); }
.modal__header { display: flex; align-items: center; justify-content: space-between; padding: 16px 20px; border-bottom: 1px solid var(--border); }
.modal__title { font-size: 16px; font-weight: 600; color: var(--text-primary); display: flex; align-items: center; gap: 8px; }
.modal__close { width: 32px; height: 32px; border: none; background: transparent; border-radius: var(--radius-md); cursor: pointer; color: var(--text-tertiary); display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
.modal__close:hover { background: var(--gray-100); color: var(--text-primary); }
.modal__body { padding: 20px; max-height: 60vh; overflow-y: auto; }
.modal__footer { display: flex; justify-content: flex-end; gap: 8px; padding: 16px 20px; border-top: 1px solid var(--border); background: var(--gray-50); }
.modal__btn { padding: 8px 16px; border: 1px solid var(--border); background: var(--background); border-radius: var(--radius-md); font-size: 13px; font-weight: 500; cursor: pointer; transition: all 0.2s; }
.modal__btn:hover { background: var(--gray-100); }
.modal__btn--primary { background: var(--primary-600); border-color: var(--primary-600); color: white; }
.modal__btn--primary:hover { background: var(--primary-700); }
.modal__btn--danger { background: var(--error); border-color: var(--error); color: white; }
.modal__btn--danger:hover { background: #dc2626; }

/* ========== Enhanced Popup Styles ========== */
.popup-header { display: flex; align-items: center; gap: 12px; padding: 20px; border-bottom: 1px solid var(--border); }
.popup-header__icon { width: 40px; height: 40px; border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
.popup-header__icon--purple { background: var(--primary-100); color: var(--primary-600); }
.popup-header__icon--green { background: #ecfdf5; color: var(--success); }
.popup-header__icon--blue { background: #dbeafe; color: var(--info); }
.popup-header__text { flex: 1; }
.popup-header__title { font-size: 16px; font-weight: 600; color: var(--text-primary); }
.popup-header__subtitle { font-size: 12px; color: var(--text-tertiary); margin-top: 2px; }
.popup-close { width: 32px; height: 32px; border: none; background: transparent; border-radius: var(--radius-md); cursor: pointer; color: var(--text-tertiary); display: flex; align-items: center; justify-content: center; transition: all 0.15s ease; }
.popup-close:hover { background: var(--gray-100); color: var(--text-primary); }

.popup-search-bar { padding: 16px 20px; border-bottom: 1px solid var(--border); display: flex; gap: 12px; }
.popup-search { flex: 1; position: relative; }
.popup-search__icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-tertiary); pointer-events: none; }
.popup-search__input { width: 100%; padding: 10px 12px 10px 40px; border: 1px solid var(--border); border-radius: var(--radius-md); font-size: 13px; font-family: var(--font-sans); background: var(--background); transition: all 0.15s ease; }
.popup-search__input:focus { outline: none; border-color: var(--primary-400); box-shadow: 0 0 0 3px var(--primary-100); }
.popup-search__input::placeholder { color: var(--text-tertiary); }

.popup-list { max-height: 320px; overflow-y: auto; padding: 8px; }
.popup-list__empty { text-align: center; padding: 40px 20px; color: var(--text-tertiary); font-size: 13px; }

.popup-item { display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: var(--radius-md); cursor: pointer; transition: background 0.15s ease; border: 1px solid transparent; }
.popup-item:hover { background: var(--gray-50); }
.popup-item--selected { background: var(--primary-50); border-color: var(--primary-200); }
.popup-item--current { background: var(--gray-50); opacity: 0.6; cursor: default; }
.popup-item__color { width: 3px; height: 40px; border-radius: 2px; flex-shrink: 0; }
.popup-item__radio { width: 18px; height: 18px; border: 2px solid var(--border); border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: all 0.15s ease; background: var(--background); }
.popup-item--selected .popup-item__radio { border-color: var(--primary-600); }
.popup-item__radio-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--primary-600); opacity: 0; transition: opacity 0.15s ease; }
.popup-item--selected .popup-item__radio-dot { opacity: 1; }
.popup-item__info { flex: 1; min-width: 0; }
.popup-item__name { font-size: 14px; font-weight: 500; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.popup-item__meta { display: flex; align-items: center; gap: 8px; margin-top: 4px; font-size: 12px; color: var(--text-tertiary); }
.popup-item__badge { font-size: 10px; font-weight: 500; padding: 2px 8px; border-radius: var(--radius-full); background: var(--gray-100); color: var(--text-secondary); }
.popup-item__badge--current { background: var(--primary-100); color: var(--primary-600); }

.popup-loadmore { padding: 12px; text-align: center; }
.popup-loadmore__btn { width: 100%; padding: 10px; border: 1px dashed var(--border); border-radius: var(--radius-md); background: transparent; font-size: 13px; font-weight: 500; color: var(--text-secondary); cursor: pointer; transition: all 0.15s ease; }
.popup-loadmore__btn:hover { background: var(--gray-50); border-color: var(--primary-300); color: var(--primary-600); }

.popup-footer { display: flex; justify-content: flex-end; gap: 8px; padding: 16px 20px; border-top: 1px solid var(--border); background: var(--gray-50); }
.popup-footer__btn { padding: 10px 20px; border: 1px solid var(--border); border-radius: var(--radius-md); font-size: 13px; font-weight: 500; cursor: pointer; transition: all 0.15s ease; background: var(--background); color: var(--text-primary); }
.popup-footer__btn:hover { background: var(--gray-100); }
.popup-footer__btn--primary { background: var(--primary-600); border-color: var(--primary-600); color: white; }
.popup-footer__btn--primary:hover { background: var(--primary-700); }
.popup-footer__btn--primary:disabled { background: var(--gray-300); border-color: var(--gray-300); cursor: not-allowed; }

.popup-current-banner { display: flex; align-items: center; gap: 8px; padding: 10px 20px; background: #fef3c7; border-bottom: 1px solid #fcd34d; font-size: 12px; color: #92400e; }
.popup-current-banner__icon { width: 16px; height: 16px; flex-shrink: 0; }

/* Modal size adjustment for popups */
.modal--popup { max-width: 480px; }
.modal--popup .modal__body { padding: 0; }
.modal--popup .modal__header { display: none; }
    </style>
</head>

<body>
    <div class="app">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar__header">
                <div class="sidebar__logo">
                    <div class="sidebar__logo-icon">
                        <svg class="icon" viewBox="0 0 24 24">
                            <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                            <path d="M2 17l10 5 10-5M2 12l10 5 10-5"/>
                        </svg>
                    </div>
                    <span class="sidebar__logo-text">GrowFit</span>
                    <span class="sidebar__logo-badge">AI</span>
                </div>

                <!-- Class Selector -->
                <div class="class-selector">
                    <button class="class-selector__button" id="classButton" onclick="toggleClassDropdown()">
                        <div class="class-selector__icon">
                            <svg class="icon icon--sm" viewBox="0 0 24 24">
                                <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/>
                                <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/>
                            </svg>
                        </div>
                        <div class="class-selector__info">
                            <div class="class-selector__name" id="selectedClassName">AI 기초 실습</div>
                            <div class="class-selector__meta">
                                <span class="class-selector__status class-selector__status--active">
                                    <span class="class-selector__status-dot"></span>진행 중
                                </span>
                                <span class="class-selector__dday" id="selectedClassDday">D-15</span>
                            </div>
                        </div>
                        <svg class="icon icon--sm class-selector__arrow" viewBox="0 0 24 24">
                            <path d="M6 9l6 6 6-6"/>
                        </svg>
                    </button>

                    <div class="class-dropdown" id="classDropdown">
                        <div class="class-dropdown__section">
                            <div class="class-dropdown__section-title">진행 중인 클래스</div>
                            <div class="class-dropdown__item class-dropdown__item--active" data-class-id="class-1" onclick="selectClass('class-1', 'AI 기초 실습', 'active', 15)">
                                <div class="class-dropdown__item-icon class-dropdown__item-icon--active">
                                    <svg class="icon" viewBox="0 0 24 24"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
                                </div>
                                <div class="class-dropdown__item-info">
                                    <div class="class-dropdown__item-name">AI 기초 실습</div>
                                    <div class="class-dropdown__item-period">2025.01.01 ~ 2025.02.01</div>
                                </div>
                                <span class="class-dropdown__item-badge class-dropdown__item-badge--active">D-15</span>
                            </div>
                            <div class="class-dropdown__item" data-class-id="class-2" onclick="selectClass('class-2', '프롬프트 엔지니어링', 'active', 30)">
                                <div class="class-dropdown__item-icon class-dropdown__item-icon--active">
                                    <svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
                                </div>
                                <div class="class-dropdown__item-info">
                                    <div class="class-dropdown__item-name">프롬프트 엔지니어링</div>
                                    <div class="class-dropdown__item-period">2025.01.15 ~ 2025.02.15</div>
                                </div>
                                <span class="class-dropdown__item-badge class-dropdown__item-badge--active">D-30</span>
                            </div>
                        </div>
                        <div class="class-dropdown__divider"></div>
                        <div class="class-dropdown__section">
                            <div class="class-dropdown__section-title">종료된 클래스</div>
                            <div class="class-dropdown__item class-dropdown__item--disabled" data-class-id="class-ended" onclick="selectClass('class-ended', '2024 AI 기초과정', 'ended', 0)">
                                <div class="class-dropdown__item-icon class-dropdown__item-icon--ended">
                                    <svg class="icon" viewBox="0 0 24 24"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
                                </div>
                                <div class="class-dropdown__item-info">
                                    <div class="class-dropdown__item-name">2024 AI 기초과정</div>
                                    <div class="class-dropdown__item-period">2024.09.01 ~ 2024.10.31</div>
                                </div>
                                <span class="class-dropdown__item-badge class-dropdown__item-badge--ended">종료</span>
                            </div>
                        </div>
                    </div>
                </div>

                <button class="sidebar__new-chat">
                    <svg class="icon icon--sm" viewBox="0 0 24 24">
                        <line x1="12" y1="5" x2="12" y2="19"/>
                        <line x1="5" y1="12" x2="19" y2="12"/>
                    </svg>
                    새 대화
                </button>
            </div>

            <nav class="sidebar__nav">
                <a class="sidebar__nav-item">
                    <span class="sidebar__nav-icon">
                        <svg class="icon" viewBox="0 0 24 24">
                            <rect x="2" y="3" width="20" height="14" rx="2" ry="2"/>
                            <line x1="8" y1="21" x2="16" y2="21"/>
                            <line x1="12" y1="17" x2="12" y2="21"/>
                        </svg>
                    </span>
                    <span>AI 실습</span>
                </a>
                <a class="sidebar__nav-item">
                    <span class="sidebar__nav-icon">
                        <svg class="icon" viewBox="0 0 24 24">
                            <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
                        </svg>
                    </span>
                    <span>내 프로젝트</span>
                </a>
                <a class="sidebar__nav-item sidebar__nav-item--active">
                    <span class="sidebar__nav-icon">
                        <svg class="icon" viewBox="0 0 24 24">
                            <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>
                            <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
                        </svg>
                    </span>
                    <span>지식베이스</span>
                </a>
                <a class="sidebar__nav-item">
                    <span class="sidebar__nav-icon">
                        <svg class="icon" viewBox="0 0 24 24">
                            <rect x="3" y="11" width="18" height="10" rx="2"/>
                            <circle cx="12" cy="5" r="3"/>
                            <path d="M12 8v3"/>
                        </svg>
                    </span>
                    <span>내 에이전트</span>
                </a>
                <a class="sidebar__nav-item">
                    <span class="sidebar__nav-icon">
                        <svg class="icon" viewBox="0 0 24 24">
                            <polyline points="16 3 21 3 21 8"/>
                            <line x1="4" y1="20" x2="21" y2="3"/>
                            <polyline points="21 16 21 21 16 21"/>
                            <line x1="15" y1="15" x2="21" y2="21"/>
                            <line x1="4" y1="4" x2="9" y2="9"/>
                        </svg>
                    </span>
                    <span>워크플로우</span>
                </a>
                <a class="sidebar__nav-item">
                    <span class="sidebar__nav-icon">
                        <svg class="icon" viewBox="0 0 24 24">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                            <polyline points="14 2 14 8 20 8"/>
                            <line x1="16" y1="13" x2="8" y2="13"/>
                            <line x1="16" y1="17" x2="8" y2="17"/>
                        </svg>
                    </span>
                    <span>내 기록</span>
                </a>
            </nav>

            <div class="sidebar__section-header">
                <span class="sidebar__section-title">최근 대화</span>
                <button class="sidebar__section-search" onclick="openSearchModal()">
                    <svg class="icon icon--sm" viewBox="0 0 24 24">
                        <circle cx="11" cy="11" r="8"/>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                    </svg>
                </button>
            </div>
            <div class="sidebar__history" id="chatHistory"></div>

            <div class="sidebar__footer">
                <div class="sidebar__footer-item">
                    <svg class="icon icon--sm" viewBox="0 0 24 24">
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                    </svg>
                    <span>설정</span>
                </div>
                <div class="sidebar__user">
                    <div class="sidebar__user-avatar">홍</div>
                    <span class="sidebar__user-name">홍길동</span>
                    <svg class="icon icon--sm sidebar__logout" viewBox="0 0 24 24">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                        <polyline points="16 17 21 12 16 7"/>
                        <line x1="21" y1="12" x2="9" y2="12"/>
                    </svg>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main">
            <header class="page-header">
                <div class="page-header__left">
                    <h1 class="page-header__title">지식베이스</h1>
                </div>

            </header>

            <div class="kb-content">
                <!-- Mode Selection -->
                <div class="mode-selection" id="modeSelection">
                    <div class="mode-selection__header">
                        <h2 class="mode-selection__title">지식베이스 생성 방식 선택</h2>
                        <p class="mode-selection__desc">목적에 맞는 방식을 선택해주세요</p>
                    </div>

                    <div class="mode-cards">
                        <div class="mode-card" id="simpleCard" onclick="selectMode('simple')">
                            <div class="mode-card__check">
                                <svg class="icon icon--sm" viewBox="0 0 24 24">
                                    <polyline points="20 6 9 17 4 12"/>
                                </svg>
                            </div>
                            <div class="mode-card__icon mode-card__icon--simple">
                                <svg class="icon icon--lg" viewBox="0 0 24 24">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                    <polyline points="17 8 12 3 7 8"/>
                                    <line x1="12" y1="3" x2="12" y2="15"/>
                                </svg>
                            </div>
                            <h3 class="mode-card__title">간편 업로드</h3>
                            <p class="mode-card__desc">파일만 업로드하면 자동으로 최적화된 설정이 적용됩니다. 빠르고 간편하게 시작하세요.</p>
                            <div class="mode-card__features">
                                <div class="mode-card__feature">
                                    <svg class="icon icon--sm mode-card__feature-icon" viewBox="0 0 24 24">
                                        <polyline points="20 6 9 17 4 12"/>
                                    </svg>
                                    자동 청킹 설정
                                </div>
                                <div class="mode-card__feature">
                                    <svg class="icon icon--sm mode-card__feature-icon" viewBox="0 0 24 24">
                                        <polyline points="20 6 9 17 4 12"/>
                                    </svg>
                                    최적화된 검색 파라미터
                                </div>
                                <div class="mode-card__feature">
                                    <svg class="icon icon--sm mode-card__feature-icon" viewBox="0 0 24 24">
                                        <polyline points="20 6 9 17 4 12"/>
                                    </svg>
                                    1분 내 설정 완료
                                </div>
                            </div>
                        </div>

                        <div class="mode-card" id="advancedCard" onclick="selectMode('advanced')">
                            <div class="mode-card__check">
                                <svg class="icon icon--sm" viewBox="0 0 24 24">
                                    <polyline points="20 6 9 17 4 12"/>
                                </svg>
                            </div>
                            <div class="mode-card__icon mode-card__icon--advanced">
                                <svg class="icon icon--lg" viewBox="0 0 24 24">
                                    <circle cx="12" cy="12" r="3"/>
                                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                                </svg>
                            </div>
                            <h3 class="mode-card__title">고급 설정</h3>
                            <p class="mode-card__desc">청킹 방식, 검색 파라미터를 직접 설정합니다. RAG 학습에 최적화된 모드입니다.</p>
                            <div class="mode-card__features">
                                <div class="mode-card__feature">
                                    <svg class="icon icon--sm mode-card__feature-icon" viewBox="0 0 24 24">
                                        <polyline points="20 6 9 17 4 12"/>
                                    </svg>
                                    청킹 방식 선택
                                </div>
                                <div class="mode-card__feature">
                                    <svg class="icon icon--sm mode-card__feature-icon" viewBox="0 0 24 24">
                                        <polyline points="20 6 9 17 4 12"/>
                                    </svg>
                                    검색 파라미터 조정
                                </div>
                                <div class="mode-card__feature">
                                    <svg class="icon icon--sm mode-card__feature-icon" viewBox="0 0 24 24">
                                        <polyline points="20 6 9 17 4 12"/>
                                    </svg>
                                    미리보기 및 테스트
                                </div>
                            </div>
                        </div>

                        <div class="mode-card" id="compareCard" onclick="selectMode('compare')">
                            <div class="mode-card__check">
                                <svg class="icon icon--sm" viewBox="0 0 24 24">
                                    <polyline points="20 6 9 17 4 12"/>
                                </svg>
                            </div>
                            <div class="mode-card__icon mode-card__icon--compare">
                                <svg class="icon icon--lg" viewBox="0 0 24 24">
                                    <rect x="3" y="3" width="7" height="7"/>
                                    <rect x="14" y="3" width="7" height="7"/>
                                    <rect x="14" y="14" width="7" height="7"/>
                                    <rect x="3" y="14" width="7" height="7"/>
                                </svg>
                            </div>
                            <h3 class="mode-card__title">비교 모드</h3>
                            <p class="mode-card__desc">서로 다른 RAG 설정의 결과를 나란히 비교하며 최적의 설정을 찾아보세요.</p>
                            <div class="mode-card__features">
                                <div class="mode-card__feature">
                                    <svg class="icon icon--sm mode-card__feature-icon" viewBox="0 0 24 24">
                                        <polyline points="20 6 9 17 4 12"/>
                                    </svg>
                                    A/B 설정 비교
                                </div>
                                <div class="mode-card__feature">
                                    <svg class="icon icon--sm mode-card__feature-icon" viewBox="0 0 24 24">
                                        <polyline points="20 6 9 17 4 12"/>
                                    </svg>
                                    실시간 결과 비교
                                </div>
                                <div class="mode-card__feature">
                                    <svg class="icon icon--sm mode-card__feature-icon" viewBox="0 0 24 24">
                                        <polyline points="20 6 9 17 4 12"/>
                                    </svg>
                                    성능 지표 분석
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- File List Section -->
                    <div class="file-list-section" id="fileListSection">
                        <div class="file-list-header">
                            <h3 class="file-list-title">업로드된 파일</h3>
                            <span class="file-list-count" id="fileCount">3개 파일</span>
                        </div>
                        
                        <!-- Stats Summary Bar -->
                        <div class="stats-summary" id="statsSummary">
                            <div class="stats-summary__item">
                                <div class="stats-summary__icon stats-summary__icon--files">
                                    <svg class="icon" viewBox="0 0 24 24">
                                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                        <polyline points="14 2 14 8 20 8"/>
                                    </svg>
                                </div>
                                <div class="stats-summary__info">
                                    <span class="stats-summary__value" id="statsTotalFiles">3</span>
                                    <span class="stats-summary__label">총 파일</span>
                                </div>
                            </div>
                            <div class="stats-summary__item">
                                <div class="stats-summary__icon stats-summary__icon--chunks">
                                    <svg class="icon" viewBox="0 0 24 24">
                                        <rect x="3" y="3" width="7" height="7"/>
                                        <rect x="14" y="3" width="7" height="7"/>
                                        <rect x="14" y="14" width="7" height="7"/>
                                        <rect x="3" y="14" width="7" height="7"/>
                                    </svg>
                                </div>
                                <div class="stats-summary__info">
                                    <span class="stats-summary__value" id="statsTotalChunks">217</span>
                                    <span class="stats-summary__label">총 청크</span>
                                </div>
                            </div>
                            <div class="stats-summary__item">
                                <div class="stats-summary__icon stats-summary__icon--ready">
                                    <svg class="icon" viewBox="0 0 24 24">
                                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                                        <polyline points="22 4 12 14.01 9 11.01"/>
                                    </svg>
                                </div>
                                <div class="stats-summary__info">
                                    <span class="stats-summary__value" id="statsReadyFiles">2</span>
                                    <span class="stats-summary__label">처리 완료</span>
                                </div>
                            </div>
                            <div class="stats-summary__item">
                                <div class="stats-summary__icon stats-summary__icon--failed">
                                    <svg class="icon" viewBox="0 0 24 24">
                                        <circle cx="12" cy="12" r="10"/>
                                        <line x1="15" y1="9" x2="9" y2="15"/>
                                        <line x1="9" y1="9" x2="15" y2="15"/>
                                    </svg>
                                </div>
                                <div class="stats-summary__info">
                                    <span class="stats-summary__value" id="statsFailedFiles">0</span>
                                    <span class="stats-summary__label">처리 실패</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- File List Toolbar -->
                        <div class="file-list-toolbar">
                            <div class="file-search">
                                <svg class="icon icon--sm file-search__icon" viewBox="0 0 24 24">
                                    <circle cx="11" cy="11" r="8"/>
                                    <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                                </svg>
                                <input type="text" class="file-search__input" id="fileSearchInput" placeholder="파일명으로 검색..." oninput="filterFiles()">
                            </div>
                            
                            <div class="file-filter" id="statusFilter">
                                <button class="file-filter__button" onclick="toggleFilterDropdown('status')">
                                    <span id="statusFilterLabel">전체 상태</span>
                                    <svg class="icon icon--sm file-filter__arrow" viewBox="0 0 24 24">
                                        <path d="M6 9l6 6 6-6"/>
                                    </svg>
                                </button>
                                <div class="file-filter__dropdown" id="statusDropdown">
                                    <div class="file-filter__item selected" data-value="all" onclick="selectFilter('status', 'all', '전체 상태')">
                                        <svg class="icon icon--sm file-filter__check" viewBox="0 0 24 24">
                                            <polyline points="20 6 9 17 4 12"/>
                                        </svg>
                                        전체 상태
                                    </div>
                                    <div class="file-filter__item" data-value="ready" onclick="selectFilter('status', 'ready', '처리 완료')">
                                        <svg class="icon icon--sm file-filter__check" viewBox="0 0 24 24">
                                            <polyline points="20 6 9 17 4 12"/>
                                        </svg>
                                        처리 완료
                                    </div>
                                    <div class="file-filter__item" data-value="failed" onclick="selectFilter('status', 'failed', '처리 실패')">
                                        <svg class="icon icon--sm file-filter__check" viewBox="0 0 24 24">
                                            <polyline points="20 6 9 17 4 12"/>
                                        </svg>
                                        처리 실패
                                    </div>
                                </div>
                            </div>
                            
                            <div class="file-filter" id="sortFilter">
                                <button class="file-filter__button" onclick="toggleFilterDropdown('sort')">
                                    <span id="sortFilterLabel">최근 업로드순</span>
                                    <svg class="icon icon--sm file-filter__arrow" viewBox="0 0 24 24">
                                        <path d="M6 9l6 6 6-6"/>
                                    </svg>
                                </button>
                                <div class="file-filter__dropdown" id="sortDropdown">
                                    <div class="file-filter__item selected" data-value="recent" onclick="selectFilter('sort', 'recent', '최근 업로드순')">
                                        <svg class="icon icon--sm file-filter__check" viewBox="0 0 24 24">
                                            <polyline points="20 6 9 17 4 12"/>
                                        </svg>
                                        최근 업로드순
                                    </div>
                                    <div class="file-filter__item" data-value="oldest" onclick="selectFilter('sort', 'oldest', '오래된순')">
                                        <svg class="icon icon--sm file-filter__check" viewBox="0 0 24 24">
                                            <polyline points="20 6 9 17 4 12"/>
                                        </svg>
                                        오래된순
                                    </div>
                                    <div class="file-filter__item" data-value="name" onclick="selectFilter('sort', 'name', '이름순')">
                                        <svg class="icon icon--sm file-filter__check" viewBox="0 0 24 24">
                                            <polyline points="20 6 9 17 4 12"/>
                                        </svg>
                                        이름순
                                    </div>
                                    <div class="file-filter__item" data-value="size" onclick="selectFilter('sort', 'size', '크기순')">
                                        <svg class="icon icon--sm file-filter__check" viewBox="0 0 24 24">
                                            <polyline points="20 6 9 17 4 12"/>
                                        </svg>
                                        크기순
                                    </div>
                                </div>
                            </div>
                            
                            <div class="file-view-toggle">
                                <button class="file-view-toggle__btn active" id="gridViewBtn" onclick="setViewMode('grid')" title="그리드 보기">
                                    <svg class="icon icon--sm" viewBox="0 0 24 24">
                                        <rect x="3" y="3" width="7" height="7"/>
                                        <rect x="14" y="3" width="7" height="7"/>
                                        <rect x="14" y="14" width="7" height="7"/>
                                        <rect x="3" y="14" width="7" height="7"/>
                                    </svg>
                                </button>
                                <button class="file-view-toggle__btn" id="listViewBtn" onclick="setViewMode('list')" title="리스트 보기">
                                    <svg class="icon icon--sm" viewBox="0 0 24 24">
                                        <line x1="8" y1="6" x2="21" y2="6"/>
                                        <line x1="8" y1="12" x2="21" y2="12"/>
                                        <line x1="8" y1="18" x2="21" y2="18"/>
                                        <line x1="3" y1="6" x2="3.01" y2="6"/>
                                        <line x1="3" y1="12" x2="3.01" y2="12"/>
                                        <line x1="3" y1="18" x2="3.01" y2="18"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Selection Bar -->
                        <div class="selection-bar hidden" id="selectionBar">
                            <label class="selection-bar__checkbox">
                                <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()">
                                <span class="selection-bar__checkbox-label">전체 선택</span>
                            </label>
                            <span class="selection-bar__count" id="selectedCount">0개 선택됨</span>
                            <div class="selection-bar__actions">
                                <button class="selection-bar__btn selection-bar__btn--cancel" onclick="clearSelection()">
                                    선택 취소
                                </button>
                                <button class="selection-bar__btn selection-bar__btn--delete" onclick="deleteSelectedFiles()">
                                    <svg class="icon icon--sm" viewBox="0 0 24 24">
                                        <polyline points="3 6 5 6 21 6"/>
                                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                                    </svg>
                                    선택 삭제
                                </button>
                            </div>
                        </div>
                        
                        <div class="file-grid" id="fileGrid"></div>
                        
                        <!-- Pagination -->
                        <div class="pagination" id="pagination">
                            <button class="pagination__btn" id="prevPageBtn" onclick="changePage('prev')" disabled>
                                <svg class="icon icon--sm" viewBox="0 0 24 24">
                                    <polyline points="15 18 9 12 15 6"/>
                                </svg>
                                이전
                            </button>
                            <div id="pageNumbers"></div>
                            <button class="pagination__btn" id="nextPageBtn" onclick="changePage('next')">
                                다음
                                <svg class="icon icon--sm" viewBox="0 0 24 24">
                                    <polyline points="9 18 15 12 9 6"/>
                                </svg>
                            </button>
                            <span class="pagination__info" id="paginationInfo"></span>
                        </div>
                        
                        <div class="empty-state" id="emptyState" style="display: none;">
                            <div class="empty-state__icon">
                                <svg class="icon icon--lg" viewBox="0 0 24 24">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                    <polyline points="14 2 14 8 20 8"/>
                                </svg>
                            </div>
                            <div class="empty-state__title">파일이 없습니다</div>
                            <div class="empty-state__desc">파일을 업로드하여 지식베이스를 구축하세요</div>
                        </div>
                    </div>
                </div>

                <!-- Simple Upload Mode -->
                <div class="simple-upload" id="simpleUpload">
                    <div class="simple-upload__back" onclick="goBack()">
                        <svg class="icon icon--sm" viewBox="0 0 24 24">
                            <line x1="19" y1="12" x2="5" y2="12"/>
                            <polyline points="12 19 5 12 12 5"/>
                        </svg>
                        모드 선택으로 돌아가기
                    </div>

                    <div class="step-card">
                        <div class="step-card__header">
                            <h3 class="step-card__title">파일 업로드</h3>
                            <p class="step-card__desc">AI 학습에 활용될 문서를 업로드하세요</p>
                        </div>

                        <div class="upload-zone" id="simpleUploadZone" onclick="document.getElementById('simpleFileInput').click()">
                            <input type="file" id="simpleFileInput" multiple accept=".pdf,.txt,.docx,.csv" style="display:none" onchange="handleFileUpload(this.files, 'simple')">
                            <div class="upload-zone__icon">
                                <svg class="icon icon--lg" viewBox="0 0 24 24">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                    <polyline points="17 8 12 3 7 8"/>
                                    <line x1="12" y1="3" x2="12" y2="15"/>
                                </svg>
                            </div>
                            <div class="upload-zone__title">파일을 드래그하거나 클릭하여 업로드</div>
                            <div class="upload-zone__desc">AI가 문서를 분석하여 대화에 활용할 수 있습니다</div>
                            <div class="upload-zone__formats">지원 형식: PDF, TXT, DOCX, CSV (최대 10MB)</div>
                        </div>
                        <div class="upload-progress" id="simpleUploadProgress"></div>
                    </div>
                </div>

                <!-- Advanced Mode -->
                <div class="advanced-mode" id="advancedMode">
                    <div class="advanced-mode__back" onclick="goBack()">
                        <svg class="icon icon--sm" viewBox="0 0 24 24">
                            <line x1="19" y1="12" x2="5" y2="12"/>
                            <polyline points="12 19 5 12 12 5"/>
                        </svg>
                        모드 선택으로 돌아가기
                    </div>

                    <!-- Stepper -->
                    <div class="stepper">
                        <div class="stepper__step">
                            <div class="stepper__circle stepper__circle--active" id="stepCircle1">1</div>
                            <span class="stepper__label stepper__label--active" id="stepLabel1">데이터 소스</span>
                        </div>
                        <div class="stepper__line" id="stepLine1"></div>
                        <div class="stepper__step">
                            <div class="stepper__circle" id="stepCircle2">2</div>
                            <span class="stepper__label" id="stepLabel2">청킹 설정</span>
                        </div>
                        <div class="stepper__line" id="stepLine2"></div>
                        <div class="stepper__step">
                            <div class="stepper__circle" id="stepCircle3">3</div>
                            <span class="stepper__label" id="stepLabel3">검색 설정</span>
                        </div>
                        <div class="stepper__line" id="stepLine3"></div>
                        <div class="stepper__step">
                            <div class="stepper__circle" id="stepCircle4">4</div>
                            <span class="stepper__label" id="stepLabel4">미리보기</span>
                        </div>
                    </div>

                    <!-- Step 1: Data Source -->
                    <div class="step step--active" id="step1">
                        <div class="step-card">
                            <div class="step-card__header">
                                <h3 class="step-card__title">데이터 소스 선택</h3>
                                <p class="step-card__desc">지식베이스에 추가할 파일을 업로드해주세요</p>
                            </div>

                            <div class="upload-zone" id="advancedUploadZone" onclick="document.getElementById('advancedFileInput').click()">
                                <input type="file" id="advancedFileInput" multiple accept=".pdf,.txt,.docx,.csv" style="display:none" onchange="handleFileUpload(this.files, 'advanced')">
                                <div class="upload-zone__icon">
                                    <svg class="icon icon--lg" viewBox="0 0 24 24">
                                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                        <polyline points="17 8 12 3 7 8"/>
                                        <line x1="12" y1="3" x2="12" y2="15"/>
                                    </svg>
                                </div>
                                <div class="upload-zone__title">파일을 드래그하거나 클릭</div>
                                <div class="upload-zone__desc">PDF, TXT, DOCX, CSV 파일 지원</div>
                            </div>
                            <div class="upload-progress" id="advancedUploadProgress"></div>

                            <div class="step-actions">
                                <button class="btn btn--outline" onclick="goBack()">취소</button>
                                <button class="btn btn--primary" onclick="goToStep(2)">다음 단계</button>
                            </div>
                        </div>
                    </div>

                    <!-- Step 2: Chunking -->
                    <div class="step" id="step2">
                        <div class="step-card" id="chunkingStepCard">
                            <!-- Settings Section (왼쪽) -->
                            <div class="step-card__settings">
                                <div class="step-card__header">
                                    <h3 class="step-card__title">청킹 설정</h3>
                                    <p class="step-card__desc">문서를 어떻게 나눌지 설정합니다</p>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">청킹 방식</label>
                                    <div class="option-cards">
                                        <div class="option-card option-card--active" onclick="selectOption(this); updateChunkPreview();">
                                            <div class="option-card__header">
                                                <div class="option-card__icon option-card__icon--blue">
                                                    <svg class="icon icon--sm" viewBox="0 0 24 24">
                                                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                                        <line x1="3" y1="9" x2="21" y2="9"/>
                                                        <line x1="3" y1="15" x2="21" y2="15"/>
                                                    </svg>
                                                </div>
                                                <span class="option-card__title">일반</span>
                                                <span class="option-card__badge">권장</span>
                                            </div>
                                            <p class="option-card__desc">텍스트 청크 모드에서는 검색된 청크와 회수된 청크가 동일합니다.</p>
                                        </div>
                                        <div class="option-card" onclick="selectOption(this); updateChunkPreview();">
                                            <div class="option-card__header">
                                                <div class="option-card__icon option-card__icon--purple">
                                                    <svg class="icon icon--sm" viewBox="0 0 24 24">
                                                        <circle cx="12" cy="12" r="4"/>
                                                        <circle cx="12" cy="12" r="9"/>
                                                    </svg>
                                                </div>
                                                <span class="option-card__title">부모-자식</span>
                                            </div>
                                            <p class="option-card__desc">자식 청크는 검색에 사용되고 부모 청크는 컨텍스트로 회수됩니다.</p>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">세그먼트 식별자</label>
                                        <input type="text" class="form-input" id="segmentIdentifier" value="#n#n" placeholder="예: ###, ---" oninput="updateChunkPreview()">
                                        <p class="form-hint">마크다운 헤더나 구분선으로 문서 분할</p>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">최대 청크 길이 <span class="form-label__hint">(자)</span></label>
                                        <input type="number" class="form-input" id="maxChunkLength" value="1024" min="128" max="4096" oninput="updateChunkPreview()">
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">청크 중첩 <span class="form-label__hint">(자)</span></label>
                                    <input type="number" class="form-input" id="chunkOverlap" value="50" min="0" max="200" style="max-width: 200px;" oninput="updateChunkPreview()">
                                    <p class="form-hint">청크 간 문맥 연결을 위한 중복 영역</p>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">텍스트 전처리 규칙</label>
                                    <div class="checkbox-group">
                                        <label class="checkbox-item">
                                            <input type="checkbox" id="replaceSpaces" checked onchange="updateChunkPreview()">
                                            <span class="checkbox-item__label">연속된 공백, 줄바꿈, 탭을 대체합니다</span>
                                        </label>
                                        <label class="checkbox-item">
                                            <input type="checkbox" id="removeUrls" onchange="updateChunkPreview()">
                                            <span class="checkbox-item__label">모든 URL과 이메일 주소를 제거합니다</span>
                                        </label>
                                    </div>
                                </div>

                                <button class="btn btn--outline btn--sm" id="previewChunkBtn" onclick="toggleChunkPreview()">
                                    <svg class="icon icon--sm" viewBox="0 0 24 24">
                                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                        <circle cx="12" cy="12" r="3"/>
                                    </svg>
                                    <span id="previewBtnText">프리뷰 청크</span>
                                </button>

                                <div class="step-actions">
                                    <button class="btn btn--outline" onclick="goToStep(1)">이전</button>
                                    <button class="btn btn--primary" onclick="goToStep(3)">다음 단계</button>
                                </div>
                            </div>

                            <!-- Preview Panel (오른쪽) - 토글로 표시 -->
                            <div class="step-card__preview" id="chunkPreviewPanel" style="display: none;">
                                <div class="step-card__preview-header">
                                    <div class="step-card__preview-title">
                                        <svg class="icon icon--sm" viewBox="0 0 24 24">
                                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                            <line x1="3" y1="9" x2="21" y2="9"/>
                                            <line x1="3" y1="15" x2="21" y2="15"/>
                                        </svg>
                                        청크 미리보기
                                    </div>
                                    <button class="step-card__preview-close" onclick="toggleChunkPreview()" title="미리보기 닫기">
                                        <svg class="icon icon--sm" viewBox="0 0 24 24">
                                            <line x1="18" y1="6" x2="6" y2="18"/>
                                            <line x1="6" y1="6" x2="18" y2="18"/>
                                        </svg>
                                    </button>
                                </div>
                                <div class="step-card__preview-body">
                                    <!-- Stats -->
                                    <div class="step-card__preview-stats">
                                        <div class="preview-stat">
                                            <div class="preview-stat__value" id="previewChunkCount">12</div>
                                            <div class="preview-stat__label">총 청크 수</div>
                                        </div>
                                        <div class="preview-stat">
                                            <div class="preview-stat__value" id="previewAvgLength">856</div>
                                            <div class="preview-stat__label">평균 길이</div>
                                        </div>
                                    </div>
                                    
                                    <!-- Chunk List -->
                                    <div class="step-card__preview-list" id="chunkPreviewList">
                                        <!-- 청크들이 여기에 동적으로 생성됨 -->
                                    </div>
                                </div>
                                <div class="step-card__preview-footer">
                                    <button class="preview-refresh-btn" id="refreshPreviewBtn" onclick="refreshChunkPreview()">
                                        <svg class="icon" viewBox="0 0 24 24">
                                            <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
                                            <path d="M3 3v5h5"/>
                                        </svg>
                                        미리보기 새로고침
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 3: Search Settings -->
                    <div class="step" id="step3">
                        <div class="step-card">
                            <div class="step-card__header">
                                <h3 class="step-card__title">검색 설정</h3>
                                <p class="step-card__desc">RAG 검색 방식과 파라미터를 설정합니다</p>
                            </div>

                            <div class="form-group">
                                <label class="form-label">인덱스 모드</label>
                                <div class="option-cards">
                                    <div class="option-card option-card--active" onclick="selectOption(this)">
                                        <div class="option-card__header">
                                            <div class="option-card__icon option-card__icon--blue">
                                                <svg class="icon icon--sm" viewBox="0 0 24 24">
                                                    <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                                                </svg>
                                            </div>
                                            <span class="option-card__title">고품질</span>
                                            <span class="option-card__badge">권장</span>
                                        </div>
                                        <p class="option-card__desc">임베딩 모델을 호출하여 높은 정확도의 검색 결과를 제공합니다.</p>
                                    </div>
                                    <div class="option-card" onclick="selectOption(this)">
                                        <div class="option-card__header">
                                            <div class="option-card__icon option-card__icon--purple">
                                                <svg class="icon icon--sm" viewBox="0 0 24 24">
                                                    <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>
                                                </svg>
                                            </div>
                                            <span class="option-card__title">경제적</span>
                                        </div>
                                        <p class="option-card__desc">키워드 기반 검색으로 비용을 절감합니다.</p>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">임베딩 모델</label>
                                <select class="form-select" id="embeddingModel">
                                    <option value="text-embedding-3-large">text-embedding-3-large (권장)</option>
                                    <option value="text-embedding-3-small">text-embedding-3-small</option>
                                    <option value="text-embedding-ada-002">text-embedding-ada-002</option>
                                </select>
                                <p class="form-hint">벡터 검색에 사용할 임베딩 모델을 선택합니다</p>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Top K</label>
                                <p class="form-hint">검색 시 반환할 최대 청크 수</p>
                                <div class="slider-group">
                                    <input type="range" class="slider-input" id="topK" min="1" max="20" value="5" oninput="updateSliderValue('topK', 'topKValue', '개')">
                                    <span class="slider-value" id="topKValue">5개</span>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">유사도 임계값</label>
                                <p class="form-hint">최소 유사도 점수 (%)</p>
                                <div class="slider-group">
                                    <input type="range" class="slider-input" id="threshold" min="0" max="100" value="70" oninput="updateSliderValue('threshold', 'thresholdValue', '%')">
                                    <span class="slider-value" id="thresholdValue">70%</span>
                                </div>
                            </div>

                            <div class="step-actions">
                                <button class="btn btn--outline" onclick="goToStep(2)">이전</button>
                                <button class="btn btn--primary" onclick="goToStep(4)">다음 단계</button>
                            </div>
                        </div>
                    </div>

                    <!-- Step 4: Preview -->
                    <div class="step" id="step4">
                        <div class="step-card">
                            <div class="step-card__header">
                                <h3 class="step-card__title">설정 확인</h3>
                                <p class="step-card__desc">지식베이스 설정을 확인하고 생성을 완료하세요</p>
                            </div>

                            <div class="summary-card">
                                <div class="summary-card__title">
                                    <svg class="icon icon--sm summary-card__title-icon" viewBox="0 0 24 24">
                                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                        <polyline points="14 2 14 8 20 8"/>
                                    </svg>
                                    데이터 소스
                                </div>
                                <div class="summary-list">
                                    <div class="summary-item">
                                        <span class="summary-item__label">업로드된 파일</span>
                                        <span class="summary-item__value">2개</span>
                                    </div>
                                    <div class="summary-item">
                                        <span class="summary-item__label">총 크기</span>
                                        <span class="summary-item__value">4.2 MB</span>
                                    </div>
                                </div>
                            </div>

                            <div class="summary-card">
                                <div class="summary-card__title">
                                    <svg class="icon icon--sm summary-card__title-icon" viewBox="0 0 24 24">
                                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                        <line x1="3" y1="9" x2="21" y2="9"/>
                                        <line x1="9" y1="21" x2="9" y2="9"/>
                                    </svg>
                                    청킹 설정
                                </div>
                                <div class="summary-list">
                                    <div class="summary-item">
                                        <span class="summary-item__label">청킹 방식</span>
                                        <span class="summary-item__value">일반</span>
                                    </div>
                                    <div class="summary-item">
                                        <span class="summary-item__label">최대 청크 길이</span>
                                        <span class="summary-item__value">1024자</span>
                                    </div>
                                    <div class="summary-item">
                                        <span class="summary-item__label">청크 중첩</span>
                                        <span class="summary-item__value">50자</span>
                                    </div>
                                </div>
                            </div>

                            <div class="summary-card">
                                <div class="summary-card__title">
                                    <svg class="icon icon--sm summary-card__title-icon" viewBox="0 0 24 24">
                                        <circle cx="11" cy="11" r="8"/>
                                        <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                                    </svg>
                                    검색 설정
                                </div>
                                <div class="summary-list">
                                    <div class="summary-item">
                                        <span class="summary-item__label">인덱스 모드</span>
                                        <span class="summary-item__value">고품질</span>
                                    </div>
                                    <div class="summary-item">
                                        <span class="summary-item__label">Top K</span>
                                        <span class="summary-item__value">5개</span>
                                    </div>
                                    <div class="summary-item">
                                        <span class="summary-item__label">유사도 임계값</span>
                                        <span class="summary-item__value">70%</span>
                                    </div>
                                </div>
                            </div>

                            <div class="step-actions">
                                <button class="btn btn--outline" onclick="goToStep(3)">이전</button>
                                <button class="btn btn--primary btn--lg" onclick="createKnowledgeBase()">지식베이스 생성</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Compare Mode -->
            <div class="compare-mode" id="compareMode">
                <button class="compare-mode__back" onclick="goBack()">
                    <svg class="icon" viewBox="0 0 24 24">
                        <path d="M19 12H5"/>
                        <path d="M12 19l-7-7 7-7"/>
                    </svg>
                    지식베이스로 돌아가기
                </button>

                <!-- Header Section -->
                <div class="compare-header">
                    <div class="compare-header__left">
                        <div class="compare-header__icon">
                            <svg class="icon" viewBox="0 0 24 24">
                                <path d="M9 17H7A5 5 0 0 1 7 7h2"/>
                                <path d="M15 7h2a5 5 0 1 1 0 10h-2"/>
                                <line x1="8" y1="12" x2="16" y2="12"/>
                            </svg>
                        </div>
                        <div>
                            <div class="compare-header__title">지식베이스 비교 학습</div>
                            <div class="compare-header__desc">각 패널에서 모드를 선택하여 다양한 조합으로 AI 응답을 비교해보세요</div>
                        </div>
                    </div>

                    <!-- Model Selector -->
                    <div class="model-selector">
                        <span class="model-selector__label">사용 모델</span>
                        <div class="model-selector__dropdown">
                            <button class="model-selector__button" id="modelButton" onclick="toggleModelDropdown()">
                                <span class="model-selector__dot model-selector__dot--gpt" id="selectedModelDot"></span>
                                <span class="model-selector__name" id="selectedModelName">GPT-4</span>
                                <svg class="icon icon--sm model-selector__arrow" viewBox="0 0 24 24">
                                    <path d="M6 9l6 6 6-6"/>
                                </svg>
                            </button>
                            <div class="model-dropdown" id="modelDropdown">
                                <div class="model-dropdown__item selected" data-model="gpt" onclick="selectModel('gpt', 'GPT-4')">
                                    <span class="model-selector__dot model-selector__dot--gpt"></span>
                                    <span>GPT-4</span>
                                </div>
                                <div class="model-dropdown__item" data-model="claude" onclick="selectModel('claude', 'Claude 3.5')">
                                    <span class="model-selector__dot model-selector__dot--claude"></span>
                                    <span>Claude 3.5</span>
                                </div>
                                <div class="model-dropdown__item" data-model="gemini" onclick="selectModel('gemini', 'Gemini Pro')">
                                    <span class="model-selector__dot model-selector__dot--gemini"></span>
                                    <span>Gemini Pro</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Compare Panels -->
                <div class="compare-panels">
                    <!-- Panel A -->
                    <div class="compare-panel" id="panelA">
                        <div class="compare-panel__header">
                            <div class="compare-panel__title">
                                <span class="compare-panel__badge compare-panel__badge--a">A</span>
                                패널 A
                            </div>
                            <div class="compare-panel__actions">
                                <button class="panel-reset-btn" onclick="resetPanel('A')" title="패널 초기화">
                                    <svg class="icon icon--sm" viewBox="0 0 24 24">
                                        <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
                                        <path d="M3 3v5h5"/>
                                    </svg>
                                </button>
                                <span class="mode-status mode-status--llm" id="modeStatusA">순수 LLM</span>
                            </div>
                        </div>
                        <div class="compare-panel__body">
                            <!-- Mode Selector -->
                            <div class="mode-selector">
                                <div class="mode-selector__item active" data-mode="llm" onclick="selectPanelMode('A', 'llm')">
                                    <div class="mode-selector__icon mode-selector__icon--llm">
                                        <svg class="icon icon--sm" viewBox="0 0 24 24">
                                            <rect x="2" y="3" width="20" height="14" rx="2" ry="2"/>
                                            <line x1="8" y1="21" x2="16" y2="21"/>
                                            <line x1="12" y1="17" x2="12" y2="21"/>
                                        </svg>
                                    </div>
                                    <div class="mode-selector__label">순수 LLM</div>
                                    <div class="mode-selector__desc">파일 없이<br>기본 지식만</div>
                                </div>
                                <div class="mode-selector__item" data-mode="doc" onclick="selectPanelMode('A', 'doc')">
                                    <div class="mode-selector__icon mode-selector__icon--doc">
                                        <svg class="icon icon--sm" viewBox="0 0 24 24">
                                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                            <polyline points="14 2 14 8 20 8"/>
                                        </svg>
                                    </div>
                                    <div class="mode-selector__label">문서 참조</div>
                                    <div class="mode-selector__desc">기본 설정으로<br>문서 활용</div>
                                </div>
                                <div class="mode-selector__item" data-mode="rag" onclick="selectPanelMode('A', 'rag')">
                                    <div class="mode-selector__icon mode-selector__icon--rag">
                                        <svg class="icon icon--sm" viewBox="0 0 24 24">
                                            <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/>
                                            <circle cx="12" cy="12" r="3"/>
                                        </svg>
                                    </div>
                                    <div class="mode-selector__label">RAG 설정</div>
                                    <div class="mode-selector__desc">세부 파라미터<br>직접 조절</div>
                                </div>
                            </div>

                            <!-- LLM Only Content -->
                            <div class="mode-content show" id="llmContentA">
                                <div class="llm-state">
                                    <div class="llm-state__icon">
                                        <svg class="icon icon--lg" viewBox="0 0 24 24">
                                            <rect x="2" y="3" width="20" height="14" rx="2" ry="2"/>
                                            <line x1="8" y1="21" x2="16" y2="21"/>
                                            <line x1="12" y1="17" x2="12" y2="21"/>
                                        </svg>
                                    </div>
                                    <div class="llm-state__title">순수 LLM 응답</div>
                                    <div class="llm-state__text">외부 문서 없이 AI 모델의<br>기본 학습 지식만으로 응답합니다</div>
                                </div>
                            </div>

                            <!-- Doc Reference Content -->
                            <div class="mode-content" id="docContentA">
                                <div class="doc-selector">
                                    <div class="doc-selector__label">
                                        <svg class="icon icon--sm" viewBox="0 0 24 24">
                                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                            <polyline points="14 2 14 8 20 8"/>
                                        </svg>
                                        문서 선택
                                    </div>
                                    <div class="doc-selector__dropdown">
                                        <button class="doc-selector__button" id="docButtonDocA" onclick="toggleDocDropdown('DocA')">
                                            <div class="doc-selector__icon">
                                                <svg class="icon icon--sm" viewBox="0 0 24 24">
                                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                                    <polyline points="14 2 14 8 20 8"/>
                                                </svg>
                                            </div>
                                            <div class="doc-selector__info">
                                                <span class="doc-selector__placeholder" id="docPlaceholderDocA">문서를 선택하세요</span>
                                                <div id="docSelectedDocA" style="display: none;">
                                                    <div class="doc-selector__name"></div>
                                                    <div class="doc-selector__meta"></div>
                                                </div>
                                            </div>
                                            <svg class="icon icon--sm doc-selector__arrow" viewBox="0 0 24 24">
                                                <path d="M6 9l6 6 6-6"/>
                                            </svg>
                                        </button>
                                        <div class="doc-dropdown" id="docDropdownDocA"></div>
                                    </div>
                                </div>
                                <div class="default-settings" id="defaultSettingsDocA" style="display: none;">
                                    <div class="default-settings__title">
                                        <svg class="icon icon--sm" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
                                        기본 RAG 설정 적용
                                    </div>
                                    <div class="default-settings__grid">
                                        <div class="default-settings__item">
                                            <div class="default-settings__label">Top-K</div>
                                            <div class="default-settings__value">3개</div>
                                        </div>
                                        <div class="default-settings__item">
                                            <div class="default-settings__label">Chunk</div>
                                            <div class="default-settings__value">500자</div>
                                        </div>
                                        <div class="default-settings__item">
                                            <div class="default-settings__label">유사도</div>
                                            <div class="default-settings__value">0.7</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- RAG Settings Content -->
                            <div class="mode-content" id="ragContentA">
                                <div class="doc-selector">
                                    <div class="doc-selector__label">
                                        <svg class="icon icon--sm" viewBox="0 0 24 24">
                                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                            <polyline points="14 2 14 8 20 8"/>
                                        </svg>
                                        문서 선택
                                    </div>
                                    <div class="doc-selector__dropdown">
                                        <button class="doc-selector__button" id="docButtonRagA" onclick="toggleDocDropdown('RagA')">
                                            <div class="doc-selector__icon">
                                                <svg class="icon icon--sm" viewBox="0 0 24 24">
                                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                                    <polyline points="14 2 14 8 20 8"/>
                                                </svg>
                                            </div>
                                            <div class="doc-selector__info">
                                                <span class="doc-selector__placeholder" id="docPlaceholderRagA">문서를 선택하세요</span>
                                                <div id="docSelectedRagA" style="display: none;">
                                                    <div class="doc-selector__name"></div>
                                                    <div class="doc-selector__meta"></div>
                                                </div>
                                            </div>
                                            <svg class="icon icon--sm doc-selector__arrow" viewBox="0 0 24 24">
                                                <path d="M6 9l6 6 6-6"/>
                                            </svg>
                                        </button>
                                        <div class="doc-dropdown" id="docDropdownRagA"></div>
                                    </div>
                                </div>
                                <div class="settings-section" id="settingsSectionRagA" style="display: none;">
                                    <div class="settings-section__title">
                                        <svg class="icon icon--sm" viewBox="0 0 24 24">
                                            <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/>
                                            <circle cx="12" cy="12" r="3"/>
                                        </svg>
                                        RAG 파라미터 설정
                                    </div>
                                    <div class="setting-row">
                                        <span class="setting-row__label">Top-K</span>
                                        <div class="setting-row__slider">
                                            <input type="range" min="1" max="10" value="3" id="topKA" onchange="updateSliderValue('topKA', this.value)">
                                            <span class="setting-row__value" id="topKAValue">3개</span>
                                        </div>
                                    </div>
                                    <div class="setting-row">
                                        <span class="setting-row__label">Chunk Size</span>
                                        <div class="setting-row__slider">
                                            <input type="range" min="200" max="1000" step="100" value="500" id="chunkSizeA" onchange="updateSliderValue('chunkSizeA', this.value)">
                                            <span class="setting-row__value" id="chunkSizeAValue">500자</span>
                                        </div>
                                    </div>
                                    <div class="setting-row">
                                        <span class="setting-row__label">유사도 임계값</span>
                                        <div class="setting-row__slider">
                                            <input type="range" min="0.5" max="0.9" step="0.1" value="0.7" id="thresholdA" onchange="updateSliderValue('thresholdA', this.value)">
                                            <span class="setting-row__value" id="thresholdAValue">0.7</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="section-divider"></div>

                            <!-- Test Section -->
                            <div class="test-section">
                                <div class="test-section__label">
                                    <svg class="icon icon--sm" viewBox="0 0 24 24">
                                        <circle cx="12" cy="12" r="10"/>
                                        <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
                                        <line x1="12" y1="17" x2="12.01" y2="17"/>
                                    </svg>
                                    질문 입력
                                </div>
                                <textarea class="test-input" id="questionA" rows="2" placeholder="질문을 입력하세요..." oninput="syncQuestion('A')"></textarea>
                                <div class="test-actions">
                                    <button class="btn btn--primary" id="testBtnA" onclick="runTest('A')">
                                        <svg class="icon icon--sm" viewBox="0 0 24 24">
                                            <polygon points="5 3 19 12 5 21 5 3"/>
                                        </svg>
                                        실행
                                    </button>
                                </div>
                            </div>

                            <!-- Result Box -->
                            <div class="result-box" id="resultBoxA">
                                <div class="result-card">
                                    <div class="result-card__header">
                                        <span class="result-card__label" id="resultLabelA">AI 응답</span>
                                        <span class="result-card__model result-card__model--gpt" id="resultModelA">
                                            <span class="model-selector__dot model-selector__dot--gpt"></span>
                                            GPT-4
                                        </span>
                                    </div>
                                    <div class="result-card__body">
                                        <div class="result-card__text" id="resultContentA">
Python은 1991년 귀도 반 로섬이 개발한 고수준 프로그래밍 언어입니다. 간결하고 읽기 쉬운 문법이 특징이며, 웹 개발, 데이터 분석, 인공지능 등 다양한 분야에서 널리 사용됩니다.

주요 특징:
• 간결하고 읽기 쉬운 문법
• 동적 타이핑 지원
• 풍부한 라이브러리 생태계
• 크로스 플랫폼 지원
• 객체지향 및 함수형 프로그래밍 지원

Python은 초보자부터 전문가까지 폭넓게 사용되는 언어입니다.
                                        </div>
                                    </div>
                                    <div class="result-card__footer">
                                        <div class="result-card__stat">
                                            <div class="result-card__stat-value" id="resultTimeA">1.2초</div>
                                            <div class="result-card__stat-label">응답 시간</div>
                                        </div>
                                        <div class="result-card__stat">
                                            <div class="result-card__stat-value" id="resultTokensA">127</div>
                                            <div class="result-card__stat-label">토큰</div>
                                        </div>
                                        <div class="result-card__stat">
                                            <div class="result-card__stat-value" id="resultChunksA">-</div>
                                            <div class="result-card__stat-label">청크</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Panel B -->
                    <div class="compare-panel" id="panelB">
                        <div class="compare-panel__header">
                            <div class="compare-panel__title">
                                <span class="compare-panel__badge compare-panel__badge--b">B</span>
                                패널 B
                            </div>
                            <div class="compare-panel__actions">
                                <button class="panel-reset-btn" onclick="resetPanel('B')" title="패널 초기화">
                                    <svg class="icon icon--sm" viewBox="0 0 24 24">
                                        <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
                                        <path d="M3 3v5h5"/>
                                    </svg>
                                </button>
                                <span class="mode-status mode-status--doc" id="modeStatusB">문서 참조</span>
                            </div>
                        </div>
                        <div class="compare-panel__body">
                            <!-- Mode Selector -->
                            <div class="mode-selector">
                                <div class="mode-selector__item" data-mode="llm" onclick="selectPanelMode('B', 'llm')">
                                    <div class="mode-selector__icon mode-selector__icon--llm">
                                        <svg class="icon icon--sm" viewBox="0 0 24 24">
                                            <rect x="2" y="3" width="20" height="14" rx="2" ry="2"/>
                                            <line x1="8" y1="21" x2="16" y2="21"/>
                                            <line x1="12" y1="17" x2="12" y2="21"/>
                                        </svg>
                                    </div>
                                    <div class="mode-selector__label">순수 LLM</div>
                                    <div class="mode-selector__desc">파일 없이<br>기본 지식만</div>
                                </div>
                                <div class="mode-selector__item active" data-mode="doc" onclick="selectPanelMode('B', 'doc')">
                                    <div class="mode-selector__icon mode-selector__icon--doc">
                                        <svg class="icon icon--sm" viewBox="0 0 24 24">
                                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                            <polyline points="14 2 14 8 20 8"/>
                                        </svg>
                                    </div>
                                    <div class="mode-selector__label">문서 참조</div>
                                    <div class="mode-selector__desc">기본 설정으로<br>문서 활용</div>
                                </div>
                                <div class="mode-selector__item" data-mode="rag" onclick="selectPanelMode('B', 'rag')">
                                    <div class="mode-selector__icon mode-selector__icon--rag">
                                        <svg class="icon icon--sm" viewBox="0 0 24 24">
                                            <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/>
                                            <circle cx="12" cy="12" r="3"/>
                                        </svg>
                                    </div>
                                    <div class="mode-selector__label">RAG 설정</div>
                                    <div class="mode-selector__desc">세부 파라미터<br>직접 조절</div>
                                </div>
                            </div>

                            <!-- LLM Only Content -->
                            <div class="mode-content" id="llmContentB">
                                <div class="llm-state">
                                    <div class="llm-state__icon">
                                        <svg class="icon icon--lg" viewBox="0 0 24 24">
                                            <rect x="2" y="3" width="20" height="14" rx="2" ry="2"/>
                                            <line x1="8" y1="21" x2="16" y2="21"/>
                                            <line x1="12" y1="17" x2="12" y2="21"/>
                                        </svg>
                                    </div>
                                    <div class="llm-state__title">순수 LLM 응답</div>
                                    <div class="llm-state__text">외부 문서 없이 AI 모델의<br>기본 학습 지식만으로 응답합니다</div>
                                </div>
                            </div>

                            <!-- Doc Reference Content -->
                            <div class="mode-content show" id="docContentB">
                                <div class="doc-selector">
                                    <div class="doc-selector__label">
                                        <svg class="icon icon--sm" viewBox="0 0 24 24">
                                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                            <polyline points="14 2 14 8 20 8"/>
                                        </svg>
                                        문서 선택
                                    </div>
                                    <div class="doc-selector__dropdown">
                                        <button class="doc-selector__button" id="docButtonDocB" onclick="toggleDocDropdown('DocB')">
                                            <div class="doc-selector__icon">
                                                <svg class="icon icon--sm" viewBox="0 0 24 24">
                                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                                    <polyline points="14 2 14 8 20 8"/>
                                                </svg>
                                            </div>
                                            <div class="doc-selector__info">
                                                <span class="doc-selector__placeholder" id="docPlaceholderDocB">문서를 선택하세요</span>
                                                <div id="docSelectedDocB" style="display: none;">
                                                    <div class="doc-selector__name"></div>
                                                    <div class="doc-selector__meta"></div>
                                                </div>
                                            </div>
                                            <svg class="icon icon--sm doc-selector__arrow" viewBox="0 0 24 24">
                                                <path d="M6 9l6 6 6-6"/>
                                            </svg>
                                        </button>
                                        <div class="doc-dropdown" id="docDropdownDocB"></div>
                                    </div>
                                </div>
                                <div class="default-settings" id="defaultSettingsDocB" style="display: none;">
                                    <div class="default-settings__title">
                                        <svg class="icon icon--sm" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
                                        기본 RAG 설정 적용
                                    </div>
                                    <div class="default-settings__grid">
                                        <div class="default-settings__item">
                                            <div class="default-settings__label">Top-K</div>
                                            <div class="default-settings__value">3개</div>
                                        </div>
                                        <div class="default-settings__item">
                                            <div class="default-settings__label">Chunk</div>
                                            <div class="default-settings__value">500자</div>
                                        </div>
                                        <div class="default-settings__item">
                                            <div class="default-settings__label">유사도</div>
                                            <div class="default-settings__value">0.7</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- RAG Settings Content -->
                            <div class="mode-content" id="ragContentB">
                                <div class="doc-selector">
                                    <div class="doc-selector__label">
                                        <svg class="icon icon--sm" viewBox="0 0 24 24">
                                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                            <polyline points="14 2 14 8 20 8"/>
                                        </svg>
                                        문서 선택
                                    </div>
                                    <div class="doc-selector__dropdown">
                                        <button class="doc-selector__button" id="docButtonRagB" onclick="toggleDocDropdown('RagB')">
                                            <div class="doc-selector__icon">
                                                <svg class="icon icon--sm" viewBox="0 0 24 24">
                                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                                    <polyline points="14 2 14 8 20 8"/>
                                                </svg>
                                            </div>
                                            <div class="doc-selector__info">
                                                <span class="doc-selector__placeholder" id="docPlaceholderRagB">문서를 선택하세요</span>
                                                <div id="docSelectedRagB" style="display: none;">
                                                    <div class="doc-selector__name"></div>
                                                    <div class="doc-selector__meta"></div>
                                                </div>
                                            </div>
                                            <svg class="icon icon--sm doc-selector__arrow" viewBox="0 0 24 24">
                                                <path d="M6 9l6 6 6-6"/>
                                            </svg>
                                        </button>
                                        <div class="doc-dropdown" id="docDropdownRagB"></div>
                                    </div>
                                </div>
                                <div class="settings-section" id="settingsSectionRagB" style="display: none;">
                                    <div class="settings-section__title">
                                        <svg class="icon icon--sm" viewBox="0 0 24 24">
                                            <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/>
                                            <circle cx="12" cy="12" r="3"/>
                                        </svg>
                                        RAG 파라미터 설정
                                    </div>
                                    <div class="setting-row">
                                        <span class="setting-row__label">Top-K</span>
                                        <div class="setting-row__slider">
                                            <input type="range" min="1" max="10" value="5" id="topKB" onchange="updateSliderValue('topKB', this.value)">
                                            <span class="setting-row__value" id="topKBValue">5개</span>
                                        </div>
                                    </div>
                                    <div class="setting-row">
                                        <span class="setting-row__label">Chunk Size</span>
                                        <div class="setting-row__slider">
                                            <input type="range" min="200" max="1000" step="100" value="500" id="chunkSizeB" onchange="updateSliderValue('chunkSizeB', this.value)">
                                            <span class="setting-row__value" id="chunkSizeBValue">500자</span>
                                        </div>
                                    </div>
                                    <div class="setting-row">
                                        <span class="setting-row__label">유사도 임계값</span>
                                        <div class="setting-row__slider">
                                            <input type="range" min="0.5" max="0.9" step="0.1" value="0.7" id="thresholdB" onchange="updateSliderValue('thresholdB', this.value)">
                                            <span class="setting-row__value" id="thresholdBValue">0.7</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="section-divider"></div>

                            <!-- Sync Notice -->
                            <div class="sync-notice">
                                <svg class="icon icon--sm" viewBox="0 0 24 24">
                                    <polyline points="23 4 23 10 17 10"/>
                                    <polyline points="1 20 1 14 7 14"/>
                                    <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
                                </svg>
                                A 패널과 동일한 질문이 자동 입력됩니다
                            </div>

                            <!-- Test Section -->
                            <div class="test-section">
                                <div class="test-section__label">
                                    <svg class="icon icon--sm" viewBox="0 0 24 24">
                                        <circle cx="12" cy="12" r="10"/>
                                        <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
                                        <line x1="12" y1="17" x2="12.01" y2="17"/>
                                    </svg>
                                    질문 입력
                                </div>
                                <textarea class="test-input" id="questionB" rows="2" placeholder="질문을 입력하세요..."></textarea>
                                <div class="test-actions">
                                    <button class="btn btn--primary" id="testBtnB" onclick="runTest('B')">
                                        <svg class="icon icon--sm" viewBox="0 0 24 24">
                                            <polygon points="5 3 19 12 5 21 5 3"/>
                                        </svg>
                                        실행
                                    </button>
                                </div>
                            </div>

                            <!-- Result Box -->
                            <div class="result-box" id="resultBoxB">
                                <div class="result-card">
                                    <div class="result-card__header">
                                        <span class="result-card__label" id="resultLabelB">AI 응답 (문서 참조)</span>
                                        <span class="result-card__model result-card__model--gpt" id="resultModelB">
                                            <span class="model-selector__dot model-selector__dot--gpt"></span>
                                            GPT-4
                                        </span>
                                    </div>
                                    <div class="result-card__body">
                                        <div class="result-card__text" id="resultContentB">
업로드하신 문서에 따르면, Python은 1991년 귀도 반 로섬이 개발한 프로그래밍 언어로, 귀사의 데이터 분석 프로젝트에서 주로 pandas와 numpy 라이브러리를 활용하고 있습니다.

문서에서 발견된 관련 내용:
• 데이터 전처리: pandas 라이브러리 사용
• 수치 계산: numpy 라이브러리 활용
• 시각화: matplotlib, seaborn 사용
• 머신러닝: scikit-learn 프레임워크 적용

귀사의 프로젝트에 최적화된 Python 버전은 3.9 이상입니다.
                                        </div>
                                    </div>
                                    <div class="result-card__footer">
                                        <div class="result-card__stat">
                                            <div class="result-card__stat-value" id="resultTimeB">1.8초</div>
                                            <div class="result-card__stat-label">응답 시간</div>
                                        </div>
                                        <div class="result-card__stat">
                                            <div class="result-card__stat-value" id="resultTokensB">156</div>
                                            <div class="result-card__stat-label">토큰</div>
                                        </div>
                                        <div class="result-card__stat">
                                            <div class="result-card__stat-value" id="resultChunksB">3개</div>
                                            <div class="result-card__stat-label">청크</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        
            </div>
            </main>
    </div>

    <!-- Context Menu for Chat Items -->
    <div class="context-menu" id="chatContextMenu">
        <div class="context-menu__item" onclick="renameChat()"><svg class="icon icon--sm" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>이름 변경</div>
        <div class="context-menu__item" id="pinChatItem" onclick="togglePinChat()"><svg class="icon icon--sm" viewBox="0 0 24 24"><path d="M12 17v5"/><path d="M9 10.76a2 2 0 0 1-1.11 1.79l-1.78.9A2 2 0 0 0 5 15.24V17h14v-1.76a2 2 0 0 0-1.11-1.79l-1.78-.9A2 2 0 0 1 15 10.76V6a2 2 0 0 0-2-2h-2a2 2 0 0 0-2 2v4.76z"/></svg><span id="pinChatText">고정</span></div>
        <div class="context-menu__divider" id="projectMenuDivider" style="display: none;"></div>
        <div class="context-menu__item context-menu__item--project-add" id="addToProjectItem" style="display: none;" onclick="addChatToProject()"><svg class="icon icon--sm" viewBox="0 0 24 24"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/><line x1="12" y1="11" x2="12" y2="17"/><line x1="9" y1="14" x2="15" y2="14"/></svg>프로젝트 추가</div>
        <div class="context-menu__item context-menu__item--project-change" id="changeProjectItem" style="display: none;" onclick="changeChatProject()"><svg class="icon icon--sm" viewBox="0 0 24 24"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/><path d="M12 11v6"/><path d="M9 14h6"/></svg>프로젝트 변경</div>
        <div class="context-menu__item context-menu__item--project-remove" id="removeFromProjectItem" style="display: none;" onclick="removeChatFromProject()"><svg class="icon icon--sm" viewBox="0 0 24 24"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/><line x1="9" y1="14" x2="15" y2="14"/></svg>프로젝트에서 제거</div>
        <div class="context-menu__divider"></div>
        <div class="context-menu__item context-menu__item--danger" onclick="deleteChat()"><svg class="icon icon--sm" viewBox="0 0 24 24"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>삭제</div>
    </div>

    <!-- Modal Overlay -->
    <div class="modal-overlay" id="modalOverlay" onclick="closeModal()">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal__header">
                <h3 class="modal__title" id="modalTitle">모달 제목</h3>
                <button class="modal__close" onclick="closeModal()">
                    <svg class="icon" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                </button>
            </div>
            <div class="modal__body" id="modalBody"></div>
            <div class="modal__footer" id="modalFooter"></div>
        </div>
    </div>

    <script>
// ========== State ==========
let currentMode = null;
let currentStep = 1;
let uploadedFiles = [];

// ========== PopupState for Project Selection ==========
const PopupState = {
    projects: {
        displayCount: 10,
        searchQuery: '',
        sortBy: 'recent',
        data: [
            { id: 'proj-1', name: 'AI 기초 실습 프로젝트', color: '#9333ea', chatCount: 5, updatedAt: '2시간 전', updatedTime: Date.now() - 7200000 },
            { id: 'proj-2', name: '프롬프트 엔지니어링', color: '#4285f4', chatCount: 8, updatedAt: '1일 전', updatedTime: Date.now() - 86400000 },
            { id: 'proj-3', name: '마케팅 문구 생성', color: '#d97757', chatCount: 3, updatedAt: '3일 전', updatedTime: Date.now() - 259200000 },
            { id: 'proj-4', name: 'GPT vs Claude 비교분석', color: '#10a37f', chatCount: 12, updatedAt: '5일 전', updatedTime: Date.now() - 432000000 },
            { id: 'proj-5', name: '코드 리팩토링 실습', color: '#a50034', chatCount: 7, updatedAt: '1주 전', updatedTime: Date.now() - 604800000 },
            { id: 'proj-6', name: '영어 번역 프로젝트', color: '#f59e0b', chatCount: 15, updatedAt: '1주 전', updatedTime: Date.now() - 691200000 },
            { id: 'proj-7', name: '데이터 분석 연습', color: '#06b6d4', chatCount: 9, updatedAt: '2주 전', updatedTime: Date.now() - 1209600000 },
            { id: 'proj-8', name: '챗봇 시나리오 작성', color: '#8b5cf6', chatCount: 4, updatedAt: '2주 전', updatedTime: Date.now() - 1296000000 }
        ]
    },
    addToProject: {
        chatId: null,
        selectedProjectId: null,
        searchQuery: '',
        displayCount: 10
    },
    changeProject: {
        chatId: null,
        currentProjectId: null,
        selectedProjectId: null,
        searchQuery: '',
        displayCount: 10
    }
};

// ========== Stepper Functions ==========
function updateStepper() {
    // Update circles and labels
    for (let i = 1; i <= 4; i++) {
        const circle = document.getElementById(`stepCircle${i}`);
        const label = document.getElementById(`stepLabel${i}`);
        
        if (circle) {
            circle.classList.remove('stepper__circle--active', 'stepper__circle--completed');
            if (i < currentStep) {
                circle.classList.add('stepper__circle--completed');
                circle.innerHTML = '<svg class="icon icon--sm" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>';
            } else if (i === currentStep) {
                circle.classList.add('stepper__circle--active');
                circle.textContent = i;
            } else {
                circle.textContent = i;
            }
        }
        
        if (label) {
            label.classList.toggle('stepper__label--active', i === currentStep);
        }
    }
    
    // Update lines
    for (let i = 1; i <= 3; i++) {
        const line = document.getElementById(`stepLine${i}`);
        if (line) {
            line.classList.toggle('stepper__line--completed', i < currentStep);
        }
    }
    
    // Show/hide step content
    for (let i = 1; i <= 4; i++) {
        const step = document.getElementById(`step${i}`);
        if (step) {
            step.classList.toggle('step--active', i === currentStep);
        }
    }
}

function goToStep(step) {
    if (step >= 1 && step <= 4) {
        currentStep = step;
        updateStepper();
    }
}

function selectOption(element) {
    // Find parent container and deselect siblings
    const parent = element.parentElement;
    if (parent) {
        parent.querySelectorAll('.option-card').forEach(card => {
            card.classList.remove('option-card--active');
        });
    }
    // Select clicked option
    element.classList.add('option-card--active');
}

// Sample file data
let filesData = [
    { id: 1, name: '프롬프트 엔지니어링 가이드.pdf', type: 'pdf', size: '2.4 MB', sizeBytes: 2516582, status: 'ready', chunks: 128, date: '2025-01-10' },
    { id: 2, name: 'AI 기초 교재.docx', type: 'docx', size: '1.2 MB', sizeBytes: 1258291, status: 'ready', chunks: 89, date: '2025-01-09' },
    { id: 3, name: '실습 데이터.csv', type: 'csv', size: '540 KB', sizeBytes: 552960, status: 'failed', chunks: 0, date: '2025-01-10' },
    { id: 4, name: 'RAG 시스템 설계서.pdf', type: 'pdf', size: '3.1 MB', sizeBytes: 3250585, status: 'ready', chunks: 156, date: '2025-01-08' },
    { id: 5, name: '자연어처리 입문.docx', type: 'docx', size: '890 KB', sizeBytes: 911360, status: 'ready', chunks: 67, date: '2025-01-07' },
    { id: 6, name: '고객 FAQ 데이터.csv', type: 'csv', size: '1.5 MB', sizeBytes: 1572864, status: 'ready', chunks: 234, date: '2025-01-06' },
    { id: 7, name: 'LLM 파인튜닝 가이드.pdf', type: 'pdf', size: '4.2 MB', sizeBytes: 4404019, status: 'ready', chunks: 198, date: '2025-01-05' },
    { id: 8, name: '벡터 데이터베이스 소개.txt', type: 'txt', size: '156 KB', sizeBytes: 159744, status: 'ready', chunks: 42, date: '2025-01-04' },
    { id: 9, name: '임베딩 모델 비교.pdf', type: 'pdf', size: '2.8 MB', sizeBytes: 2936012, status: 'failed', chunks: 0, date: '2025-01-10' },
    { id: 10, name: '챗봇 설계 패턴.docx', type: 'docx', size: '1.8 MB', sizeBytes: 1887436, status: 'ready', chunks: 112, date: '2025-01-03' },
    { id: 11, name: '프로젝트 회의록.txt', type: 'txt', size: '89 KB', sizeBytes: 91136, status: 'ready', chunks: 28, date: '2025-01-02' },
    { id: 12, name: '사용자 피드백 분석.csv', type: 'csv', size: '2.1 MB', sizeBytes: 2202009, status: 'ready', chunks: 178, date: '2025-01-01' }
];

// File list filter/sort state
const fileListState = {
    searchQuery: '',
    statusFilter: 'all',
    sortBy: 'recent',
    viewMode: 'grid',
    currentPage: 1,
    itemsPerPage: 8,
    selectedFiles: []
};

// ========== File List Filter/Sort/View Functions ==========
function toggleFilterDropdown(type) {
    const dropdownId = type === 'status' ? 'statusDropdown' : 'sortDropdown';
    const buttonId = type === 'status' ? 'statusFilter' : 'sortFilter';
    const dropdown = document.getElementById(dropdownId);
    const button = document.querySelector(`#${buttonId} .file-filter__button`);
    
    // Close other dropdowns
    document.querySelectorAll('.file-filter__dropdown').forEach(d => {
        if (d.id !== dropdownId) d.classList.remove('show');
    });
    document.querySelectorAll('.file-filter__button').forEach(b => {
        if (!b.closest(`#${buttonId}`)) b.classList.remove('active');
    });
    
    dropdown.classList.toggle('show');
    button.classList.toggle('active');
}

function selectFilter(type, value, label) {
    const dropdownId = type === 'status' ? 'statusDropdown' : 'sortDropdown';
    const labelId = type === 'status' ? 'statusFilterLabel' : 'sortFilterLabel';
    const buttonId = type === 'status' ? 'statusFilter' : 'sortFilter';
    
    // Update state
    if (type === 'status') {
        fileListState.statusFilter = value;
    } else {
        fileListState.sortBy = value;
    }
    
    // Reset to first page
    fileListState.currentPage = 1;
    
    // Update UI
    document.getElementById(labelId).textContent = label;
    
    // Update selected state
    const dropdown = document.getElementById(dropdownId);
    dropdown.querySelectorAll('.file-filter__item').forEach(item => {
        item.classList.toggle('selected', item.dataset.value === value);
    });
    
    // Close dropdown
    dropdown.classList.remove('show');
    document.querySelector(`#${buttonId} .file-filter__button`).classList.remove('active');
    
    // Re-render
    renderFileList();
}

function setViewMode(mode) {
    fileListState.viewMode = mode;
    
    document.getElementById('gridViewBtn').classList.toggle('active', mode === 'grid');
    document.getElementById('listViewBtn').classList.toggle('active', mode === 'list');
    
    const grid = document.getElementById('fileGrid');
    grid.classList.toggle('file-grid--list', mode === 'list');
}

function filterFiles() {
    fileListState.searchQuery = document.getElementById('fileSearchInput').value.toLowerCase();
    fileListState.currentPage = 1; // Reset to first page on search
    renderFileList();
}

function getFilteredAndSortedFiles() {
    let filtered = [...filesData];
    
    // Apply search filter
    if (fileListState.searchQuery) {
        filtered = filtered.filter(f => f.name.toLowerCase().includes(fileListState.searchQuery));
    }
    
    // Apply status filter
    if (fileListState.statusFilter !== 'all') {
        filtered = filtered.filter(f => f.status === fileListState.statusFilter);
    }
    
    // Apply sorting
    switch (fileListState.sortBy) {
        case 'recent':
            filtered.sort((a, b) => new Date(b.date) - new Date(a.date));
            break;
        case 'oldest':
            filtered.sort((a, b) => new Date(a.date) - new Date(b.date));
            break;
        case 'name':
            filtered.sort((a, b) => a.name.localeCompare(b.name, 'ko'));
            break;
        case 'size':
            filtered.sort((a, b) => (b.sizeBytes || 0) - (a.sizeBytes || 0));
            break;
    }
    
    return filtered;
}

// ========== Pagination Functions ==========
function getPaginatedFiles(filteredFiles) {
    const startIndex = (fileListState.currentPage - 1) * fileListState.itemsPerPage;
    const endIndex = startIndex + fileListState.itemsPerPage;
    return filteredFiles.slice(startIndex, endIndex);
}

function getTotalPages(totalItems) {
    return Math.ceil(totalItems / fileListState.itemsPerPage);
}

function changePage(direction) {
    const filteredFiles = getFilteredAndSortedFiles();
    const totalPages = getTotalPages(filteredFiles.length);
    
    if (direction === 'prev' && fileListState.currentPage > 1) {
        fileListState.currentPage--;
    } else if (direction === 'next' && fileListState.currentPage < totalPages) {
        fileListState.currentPage++;
    }
    
    renderFileList();
}

function goToPage(page) {
    fileListState.currentPage = page;
    renderFileList();
}

function renderPagination(totalItems) {
    const totalPages = getTotalPages(totalItems);
    const currentPage = fileListState.currentPage;
    const pagination = document.getElementById('pagination');
    const pageNumbers = document.getElementById('pageNumbers');
    const prevBtn = document.getElementById('prevPageBtn');
    const nextBtn = document.getElementById('nextPageBtn');
    const paginationInfo = document.getElementById('paginationInfo');
    
    // Hide pagination if only one page or no items
    if (totalPages <= 1) {
        pagination.style.display = 'none';
        return;
    }
    
    pagination.style.display = 'flex';
    
    // Update prev/next buttons
    prevBtn.disabled = currentPage === 1;
    nextBtn.disabled = currentPage === totalPages;
    
    // Generate page numbers
    let pageNumbersHTML = '';
    const maxVisiblePages = 5;
    let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
    let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
    
    if (endPage - startPage + 1 < maxVisiblePages) {
        startPage = Math.max(1, endPage - maxVisiblePages + 1);
    }
    
    if (startPage > 1) {
        pageNumbersHTML += `<button class="pagination__btn" onclick="goToPage(1)">1</button>`;
        if (startPage > 2) {
            pageNumbersHTML += `<span class="pagination__ellipsis">...</span>`;
        }
    }
    
    for (let i = startPage; i <= endPage; i++) {
        pageNumbersHTML += `<button class="pagination__btn ${i === currentPage ? 'pagination__btn--active' : ''}" onclick="goToPage(${i})">${i}</button>`;
    }
    
    if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
            pageNumbersHTML += `<span class="pagination__ellipsis">...</span>`;
        }
        pageNumbersHTML += `<button class="pagination__btn" onclick="goToPage(${totalPages})">${totalPages}</button>`;
    }
    
    pageNumbers.innerHTML = pageNumbersHTML;
    
    // Update info
    const startItem = (currentPage - 1) * fileListState.itemsPerPage + 1;
    const endItem = Math.min(currentPage * fileListState.itemsPerPage, totalItems);
    paginationInfo.textContent = `${startItem}-${endItem} / ${totalItems}개`;
}

// ========== Stats Update Function ==========
function updateStats() {
    const totalFiles = filesData.length;
    const totalChunks = filesData.reduce((sum, f) => sum + (f.chunks || 0), 0);
    const readyFiles = filesData.filter(f => f.status === 'ready').length;
    const failedFiles = filesData.filter(f => f.status === 'failed').length;
    
    document.getElementById('statsTotalFiles').textContent = totalFiles.toLocaleString();
    document.getElementById('statsTotalChunks').textContent = totalChunks.toLocaleString();
    document.getElementById('statsReadyFiles').textContent = readyFiles.toLocaleString();
    document.getElementById('statsFailedFiles').textContent = failedFiles.toLocaleString();
}

// ========== File Selection Functions ==========
function toggleFileSelection(fileId) {
    const index = fileListState.selectedFiles.indexOf(fileId);
    if (index > -1) {
        fileListState.selectedFiles.splice(index, 1);
    } else {
        fileListState.selectedFiles.push(fileId);
    }
    updateSelectionUI();
}

function toggleSelectAll() {
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    const filteredFiles = getFilteredAndSortedFiles();
    const paginatedFiles = getPaginatedFiles(filteredFiles);
    
    if (selectAllCheckbox.checked) {
        // Add all visible files to selection
        paginatedFiles.forEach(file => {
            if (!fileListState.selectedFiles.includes(file.id)) {
                fileListState.selectedFiles.push(file.id);
            }
        });
    } else {
        // Remove all visible files from selection
        paginatedFiles.forEach(file => {
            const index = fileListState.selectedFiles.indexOf(file.id);
            if (index > -1) {
                fileListState.selectedFiles.splice(index, 1);
            }
        });
    }
    updateSelectionUI();
}

function clearSelection() {
    fileListState.selectedFiles = [];
    document.getElementById('selectAllCheckbox').checked = false;
    updateSelectionUI();
}

function deleteSelectedFiles() {
    const count = fileListState.selectedFiles.length;
    if (count === 0) return;
    
    openConfirmModal(
        '파일 삭제',
        `선택한 <strong>${count}개</strong>의 파일을 삭제하시겠습니까?`,
        '삭제',
        'danger',
        () => {
            filesData = filesData.filter(f => !fileListState.selectedFiles.includes(f.id));
            fileListState.selectedFiles = [];
            
            // Adjust current page if needed
            const filteredFiles = getFilteredAndSortedFiles();
            const totalPages = getTotalPages(filteredFiles.length);
            if (fileListState.currentPage > totalPages && totalPages > 0) {
                fileListState.currentPage = totalPages;
            }
            
            renderFileList();
            showToast(`${count}개의 파일이 삭제되었습니다`, 'success');
        }
    );
}

function updateSelectionUI() {
    const selectionBar = document.getElementById('selectionBar');
    const selectedCount = document.getElementById('selectedCount');
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    
    const count = fileListState.selectedFiles.length;
    
    // Show/hide selection bar
    if (count > 0) {
        selectionBar.classList.remove('hidden');
        selectedCount.textContent = `${count}개 선택됨`;
    } else {
        selectionBar.classList.add('hidden');
    }
    
    // Update checkboxes in file cards
    document.querySelectorAll('.file-card__checkbox').forEach(checkbox => {
        const fileId = parseInt(checkbox.dataset.fileId);
        checkbox.checked = fileListState.selectedFiles.includes(fileId);
        checkbox.closest('.file-card').classList.toggle('selected', checkbox.checked);
    });
    
    // Update select all checkbox state
    const filteredFiles = getFilteredAndSortedFiles();
    const paginatedFiles = getPaginatedFiles(filteredFiles);
    const allVisibleSelected = paginatedFiles.length > 0 && paginatedFiles.every(f => fileListState.selectedFiles.includes(f.id));
    selectAllCheckbox.checked = allVisibleSelected;
}

// ========== Recent Chats Data & Functions ==========
let chatData = [
    { id: 1, title: '프롬프트 엔지니어링 ...', time: '2분 전', active: true, pinned: true, projectId: 'proj-1', projectName: 'AI 기초' },
    { id: 2, title: 'GPT vs Claude 비교', time: '1시간 전', active: false, pinned: false, projectId: 'proj-1', projectName: 'AI 기초' },
    { id: 3, title: '마케팅 문구 생성', time: '어제', active: false, pinned: false, projectId: null, projectName: null },
    { id: 4, title: '코드 리뷰 요청', time: '2일 전', active: false, pinned: false, projectId: null, projectName: null }
];

function renderChatHistory() {
    const history = document.getElementById('chatHistory');
    if (!history) return;
    
    // 고정된 대화를 위로 정렬
    const sortedChats = [...chatData].sort((a, b) => {
        if (a.pinned && !b.pinned) return -1;
        if (!a.pinned && b.pinned) return 1;
        return 0;
    });
    
    history.innerHTML = sortedChats.map(chat => `
        <div class="chat-item ${chat.active ? 'chat-item--active' : ''}" onclick="loadChat(${chat.id})" data-chat-id="${chat.id}" data-project-id="${chat.projectId || ''}" data-project-name="${chat.projectName || ''}" data-pinned="${chat.pinned}">
            ${chat.pinned ? '<div class="chat-item__pin-dot"></div>' : ''}
            <div class="chat-item__icon">
                <svg class="icon icon--sm" viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
            </div>
            <div class="chat-item__info">
                <div class="chat-item__title">${escapeHtml(chat.title)}</div>
                <div class="chat-item__meta">
                    <span class="chat-item__time">${chat.time}</span>
                    ${chat.projectName ? `<span class="chat-item__project-badge"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>${chat.projectName}</span>` : ''}
                </div>
            </div>
            <button class="chat-item__menu" onclick="event.stopPropagation(); showChatContextMenu(event, ${chat.id}, ${chat.projectId ? `'${chat.projectId}'` : 'null'}, ${chat.pinned})"><svg class="icon icon--sm" viewBox="0 0 24 24"><circle cx="12" cy="12" r="1"/><circle cx="12" cy="5" r="1"/><circle cx="12" cy="19" r="1"/></svg></button>
        </div>
    `).join('');
}

// ========== Chat Context Menu ==========
function showChatContextMenu(event, chatId, projectId = null, isPinned = false) {
    const menu = document.getElementById('chatContextMenu');
    menu.style.left = event.clientX + 'px';
    menu.style.top = event.clientY + 'px';
    menu.classList.add('context-menu--open');
    menu.dataset.chatId = chatId;
    menu.dataset.projectId = projectId || '';
    menu.dataset.pinned = isPinned;
    
    // 고정/고정 해제 텍스트 변경
    const pinText = document.getElementById('pinChatText');
    if (pinText) {
        pinText.textContent = isPinned ? '고정 해제' : '고정';
    }
    
    // 프로젝트 관련 메뉴 항목 표시/숨김 처리
    const divider = document.getElementById('projectMenuDivider');
    const addToProjectItem = document.getElementById('addToProjectItem');
    const changeProjectItem = document.getElementById('changeProjectItem');
    const removeFromProjectItem = document.getElementById('removeFromProjectItem');
    
    if (projectId) {
        // 프로젝트에 속한 대화
        divider.style.display = 'block';
        addToProjectItem.style.display = 'none';
        changeProjectItem.style.display = 'flex';
        removeFromProjectItem.style.display = 'flex';
    } else {
        // 프로젝트에 속하지 않은 대화
        divider.style.display = 'block';
        addToProjectItem.style.display = 'flex';
        changeProjectItem.style.display = 'none';
        removeFromProjectItem.style.display = 'none';
    }
}

function closeChatContextMenu() { 
    document.getElementById('chatContextMenu').classList.remove('context-menu--open'); 
}

function loadChat(chatId) {
    // 모든 대화 비활성화
    chatData.forEach(c => c.active = false);
    // 선택한 대화 활성화
    const chat = chatData.find(c => c.id === chatId);
    if (chat) {
        chat.active = true;
    }
    renderChatHistory();
}

function renameChat() {
    const menu = document.getElementById('chatContextMenu');
    const chatId = parseInt(menu.dataset.chatId);
    const chat = chatData.find(c => c.id === chatId);
    closeChatContextMenu();
    
    if (chat) {
        openRenameModal(chatId, chat.title);
    }
}

function openRenameModal(chatId, currentName) {
    const modalContent = `
        <div style="padding: 20px;">
            <div style="margin-bottom: 16px;">
                <label style="display: block; font-size: 13px; font-weight: 500; color: var(--text-secondary); margin-bottom: 8px;">새 이름</label>
                <input type="text" id="renameInput" value="${escapeHtml(currentName)}" 
                    style="width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: var(--radius-md); font-size: 14px; font-family: var(--font-sans);"
                    onkeydown="if(event.key==='Enter') executeRename(${chatId})">
            </div>
        </div>
        <div style="display: flex; gap: 8px; padding: 16px 20px; border-top: 1px solid var(--border); background: var(--gray-50);">
            <button class="modal__btn" style="flex: 1;" onclick="closeModal()">취소</button>
            <button class="modal__btn modal__btn--primary" style="flex: 1;" onclick="executeRename(${chatId})">변경</button>
        </div>
    `;
    
    document.getElementById('modalTitle').innerHTML = '';
    document.getElementById('modalBody').innerHTML = modalContent;
    document.getElementById('modalFooter').style.display = 'none';
    document.querySelector('.modal').classList.add('modal--popup');
    document.getElementById('modalOverlay').classList.add('modal-overlay--open');
    
    // 입력 필드에 포커스
    setTimeout(() => {
        const input = document.getElementById('renameInput');
        if (input) {
            input.focus();
            input.select();
        }
    }, 100);
}

function executeRename(chatId) {
    const input = document.getElementById('renameInput');
    const newName = input ? input.value.trim() : '';
    
    if (newName) {
        const chat = chatData.find(c => c.id === chatId);
        if (chat) {
            chat.title = newName;
            showToast('이름이 변경되었습니다', 'success');
            renderChatHistory();
        }
    }
    closeModal();
}

function deleteChat() {
    const menu = document.getElementById('chatContextMenu');
    const chatId = parseInt(menu.dataset.chatId);
    const chat = chatData.find(c => c.id === chatId);
    closeChatContextMenu();
    
    // 커스텀 확인 모달 열기
    openConfirmModal(
        '대화 삭제',
        `"${chat ? chat.title : '이 대화'}"를 삭제하시겠습니까?`,
        '삭제',
        'danger',
        () => {
            chatData = chatData.filter(c => c.id !== chatId);
            showToast('대화가 삭제되었습니다', 'success');
            renderChatHistory();
        }
    );
}

function togglePinChat() {
    const menu = document.getElementById('chatContextMenu');
    const chatId = parseInt(menu.dataset.chatId);
    const isPinned = menu.dataset.pinned === 'true';
    closeChatContextMenu();
    
    // 실제 데이터 업데이트
    const chat = chatData.find(c => c.id === chatId);
    if (chat) {
        chat.pinned = !isPinned;
    }
    
    if (isPinned) {
        showToast('고정이 해제되었습니다', 'success');
    } else {
        showToast('대화가 고정되었습니다', 'success');
    }
    renderChatHistory();
}

function addChatToProject() {
    const menu = document.getElementById('chatContextMenu');
    const chatId = menu.dataset.chatId;
    closeChatContextMenu();
    
    // 팝업 상태 초기화
    PopupState.addToProject = {
        chatId: chatId,
        selectedProjectId: null,
        searchQuery: '',
        displayCount: 10
    };
    
    openAddToProjectPopup();
}

function openAddToProjectPopup() {
    const state = PopupState.addToProject;
    
    // 필터링 및 정렬
    let filteredProjects = [...PopupState.projects.data];
    if (state.searchQuery) {
        const query = state.searchQuery.toLowerCase();
        filteredProjects = filteredProjects.filter(p => p.name.toLowerCase().includes(query));
    }
    filteredProjects.sort((a, b) => b.updatedTime - a.updatedTime);
    
    const displayedProjects = filteredProjects.slice(0, state.displayCount);
    const hasMore = filteredProjects.length > state.displayCount;
    const remaining = filteredProjects.length - state.displayCount;
    
    const modalContent = `
        <div class="popup-header">
            <div class="popup-header__icon popup-header__icon--green">
                <svg class="icon" viewBox="0 0 24 24"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/><line x1="12" y1="11" x2="12" y2="17"/><line x1="9" y1="14" x2="15" y2="14"/></svg>
            </div>
            <div class="popup-header__text">
                <div class="popup-header__title">프로젝트에 추가</div>
                <div class="popup-header__subtitle">대화를 프로젝트에 저장</div>
            </div>
            <button class="popup-close" onclick="closeModal()">
                <svg class="icon" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
            </button>
        </div>
        
        <div class="popup-search-bar">
            <div class="popup-search" style="flex: 1;">
                <svg class="icon icon--sm popup-search__icon" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                <input type="text" class="popup-search__input" placeholder="프로젝트 검색..." value="${state.searchQuery}" oninput="filterAddToProject(this.value)">
            </div>
        </div>
        
        <div class="popup-list" id="addToProjectList">
            ${displayedProjects.length > 0 ? displayedProjects.map(proj => {
                const isSelected = proj.id === state.selectedProjectId;
                return `
                <div class="popup-item ${isSelected ? 'popup-item--selected' : ''}" onclick="selectAddToProject('${proj.id}')">
                    <div class="popup-item__radio">
                        <div class="popup-item__radio-dot"></div>
                    </div>
                    <div class="popup-item__color" style="background: ${proj.color}"></div>
                    <div class="popup-item__info">
                        <div class="popup-item__name">${escapeHtml(proj.name)}</div>
                        <div class="popup-item__meta">
                            <span>대화 ${proj.chatCount}개</span>
                            <span>•</span>
                            <span>${proj.updatedAt}</span>
                        </div>
                    </div>
                </div>
            `}).join('') : `
                <div class="popup-list__empty">
                    <p>검색 결과가 없습니다</p>
                </div>
            `}
            
            ${hasMore ? `
                <div class="popup-loadmore">
                    <button class="popup-loadmore__btn" onclick="loadMoreAddToProject()">
                        더보기 (${remaining}개 더 있음)
                    </button>
                </div>
            ` : ''}
        </div>
        
        <div class="popup-footer">
            <button class="popup-footer__btn" onclick="closeModal()">취소</button>
            <button class="popup-footer__btn popup-footer__btn--primary" onclick="confirmAddToProjectPopup()" ${!state.selectedProjectId ? 'disabled' : ''}>
                추가하기
            </button>
        </div>
    `;
    
    document.getElementById('modalTitle').innerHTML = '';
    document.getElementById('modalBody').innerHTML = modalContent;
    document.getElementById('modalFooter').style.display = 'none';
    document.querySelector('.modal').classList.add('modal--popup');
    document.getElementById('modalOverlay').classList.add('modal-overlay--open');
}

function filterAddToProject(query) {
    PopupState.addToProject.searchQuery = query;
    PopupState.addToProject.displayCount = 10;
    openAddToProjectPopup();
}

function selectAddToProject(projectId) {
    PopupState.addToProject.selectedProjectId = projectId;
    openAddToProjectPopup();
}

function loadMoreAddToProject() {
    PopupState.addToProject.displayCount += 10;
    openAddToProjectPopup();
}

function confirmAddToProjectPopup() {
    const state = PopupState.addToProject;
    const project = PopupState.projects.data.find(p => p.id === state.selectedProjectId);
    
    if (project) {
        confirmAddToProject(state.chatId, project.id, project.name);
    }
}

function confirmAddToProject(chatId, projectId, projectName) {
    closeModal();
    // 실제 데이터 업데이트
    const chat = chatData.find(c => c.id === parseInt(chatId));
    if (chat) {
        chat.projectId = projectId;
        chat.projectName = projectName;
    }
    showToast(`"${projectName}" 프로젝트에 추가되었습니다`, 'success');
    renderChatHistory();
}

function changeChatProject() {
    const menu = document.getElementById('chatContextMenu');
    const chatId = menu.dataset.chatId;
    const currentProjectId = menu.dataset.projectId;
    closeChatContextMenu();
    
    // 팝업 상태 초기화
    PopupState.changeProject = {
        chatId: chatId,
        currentProjectId: currentProjectId,
        selectedProjectId: null,
        searchQuery: '',
        displayCount: 10
    };
    
    openChangeProjectPopup();
}

function openChangeProjectPopup() {
    const state = PopupState.changeProject;
    const currentProject = PopupState.projects.data.find(p => p.id === state.currentProjectId);
    
    // 필터링 및 정렬
    let filteredProjects = [...PopupState.projects.data];
    if (state.searchQuery) {
        const query = state.searchQuery.toLowerCase();
        filteredProjects = filteredProjects.filter(p => p.name.toLowerCase().includes(query));
    }
    filteredProjects.sort((a, b) => b.updatedTime - a.updatedTime);
    
    const displayedProjects = filteredProjects.slice(0, state.displayCount);
    const hasMore = filteredProjects.length > state.displayCount;
    const remaining = filteredProjects.length - state.displayCount;
    
    const modalContent = `
        <div class="popup-header">
            <div class="popup-header__icon popup-header__icon--blue">
                <svg class="icon" viewBox="0 0 24 24"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/><path d="M12 11v6"/><path d="M9 14l3 3 3-3"/></svg>
            </div>
            <div class="popup-header__text">
                <div class="popup-header__title">프로젝트 변경</div>
                <div class="popup-header__subtitle">대화를 다른 프로젝트로 이동</div>
            </div>
            <button class="popup-close" onclick="closeModal()">
                <svg class="icon" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
            </button>
        </div>
        
        ${currentProject ? `
            <div class="popup-current-banner">
                <svg class="icon popup-current-banner__icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
                현재 위치: <strong>${escapeHtml(currentProject.name)}</strong>
            </div>
        ` : ''}
        
        <div class="popup-search-bar">
            <div class="popup-search" style="flex: 1;">
                <svg class="icon icon--sm popup-search__icon" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                <input type="text" class="popup-search__input" placeholder="프로젝트 검색..." value="${state.searchQuery}" oninput="filterChangeProject(this.value)">
            </div>
        </div>
        
        <div class="popup-list" id="changeProjectList">
            ${displayedProjects.length > 0 ? displayedProjects.map(proj => {
                const isCurrent = proj.id === state.currentProjectId;
                const isSelected = proj.id === state.selectedProjectId;
                return `
                <div class="popup-item ${isCurrent ? 'popup-item--current' : ''} ${isSelected ? 'popup-item--selected' : ''}" 
                     onclick="${isCurrent ? '' : `selectChangeProject('${proj.id}')`}">
                    <div class="popup-item__radio">
                        <div class="popup-item__radio-dot"></div>
                    </div>
                    <div class="popup-item__color" style="background: ${proj.color}"></div>
                    <div class="popup-item__info">
                        <div class="popup-item__name">
                            ${escapeHtml(proj.name)}
                            ${isCurrent ? '<span class="popup-item__badge popup-item__badge--current">현재</span>' : ''}
                        </div>
                        <div class="popup-item__meta">
                            <span>대화 ${proj.chatCount}개</span>
                            <span>•</span>
                            <span>${proj.updatedAt}</span>
                        </div>
                    </div>
                </div>
            `}).join('') : `
                <div class="popup-list__empty">
                    <p>검색 결과가 없습니다</p>
                </div>
            `}
            
            ${hasMore ? `
                <div class="popup-loadmore">
                    <button class="popup-loadmore__btn" onclick="loadMoreChangeProject()">
                        더보기 (${remaining}개 더 있음)
                    </button>
                </div>
            ` : ''}
        </div>
        
        <div class="popup-footer">
            <button class="popup-footer__btn" onclick="closeModal()">취소</button>
            <button class="popup-footer__btn popup-footer__btn--primary" onclick="confirmChangeProjectPopup()" ${!state.selectedProjectId ? 'disabled' : ''}>
                이동하기
            </button>
        </div>
    `;
    
    document.getElementById('modalTitle').innerHTML = '';
    document.getElementById('modalBody').innerHTML = modalContent;
    document.getElementById('modalFooter').style.display = 'none';
    document.querySelector('.modal').classList.add('modal--popup');
    document.getElementById('modalOverlay').classList.add('modal-overlay--open');
}

function filterChangeProject(query) {
    PopupState.changeProject.searchQuery = query;
    PopupState.changeProject.displayCount = 10;
    openChangeProjectPopup();
}

function selectChangeProject(projectId) {
    PopupState.changeProject.selectedProjectId = projectId;
    openChangeProjectPopup();
}

function loadMoreChangeProject() {
    PopupState.changeProject.displayCount += 10;
    openChangeProjectPopup();
}

function confirmChangeProjectPopup() {
    const state = PopupState.changeProject;
    const project = PopupState.projects.data.find(p => p.id === state.selectedProjectId);
    
    if (project) {
        confirmChangeProject(state.chatId, project.id, project.name);
    }
}

function confirmChangeProject(chatId, projectId, projectName) {
    closeModal();
    // 실제 데이터 업데이트
    const chat = chatData.find(c => c.id === parseInt(chatId));
    if (chat) {
        chat.projectId = projectId;
        chat.projectName = projectName;
    }
    showToast(`"${projectName}" 프로젝트로 변경되었습니다`, 'success');
    renderChatHistory();
}

function removeChatFromProject() {
    const menu = document.getElementById('chatContextMenu');
    const chatId = parseInt(menu.dataset.chatId);
    closeChatContextMenu();
    
    // 커스텀 확인 모달 열기
    openConfirmModal(
        '프로젝트에서 제거',
        '프로젝트에서 이 대화를 제거하시겠습니까?<br><span style="color: var(--text-tertiary); font-size: 12px;">대화는 삭제되지 않고 "최근 대화" 목록으로 이동합니다.</span>',
        '제거',
        'warning',
        () => {
            const chat = chatData.find(c => c.id === chatId);
            if (chat) {
                chat.projectId = null;
                chat.projectName = null;
            }
            showToast('프로젝트에서 제거되었습니다', 'success');
            renderChatHistory();
        }
    );
}

// ========== Modal Functions ==========
let confirmCallback = null;

function openConfirmModal(title, message, confirmText, type, callback) {
    confirmCallback = callback;
    
    const iconColor = type === 'danger' ? 'var(--error)' : type === 'warning' ? 'var(--warning)' : 'var(--primary-600)';
    const iconBg = type === 'danger' ? '#fef2f2' : type === 'warning' ? '#fffbeb' : 'var(--primary-100)';
    const btnClass = type === 'danger' ? 'modal__btn--danger' : 'modal__btn--primary';
    
    const modalContent = `
        <div style="text-align: center; padding: 20px;">
            <div style="width: 48px; height: 48px; background: ${iconBg}; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px;">
                <svg style="width: 24px; height: 24px; color: ${iconColor};" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    ${type === 'danger' ? '<path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>' : '<circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/>'}
                </svg>
            </div>
            <h3 style="font-size: 16px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">${title}</h3>
            <p style="font-size: 14px; color: var(--text-secondary); line-height: 1.5;">${message}</p>
        </div>
        <div style="display: flex; gap: 8px; padding: 16px 20px; border-top: 1px solid var(--border); background: var(--gray-50);">
            <button class="modal__btn" style="flex: 1;" onclick="closeModal()">취소</button>
            <button class="modal__btn ${btnClass}" style="flex: 1;" onclick="executeConfirm()">${confirmText}</button>
        </div>
    `;
    
    document.getElementById('modalTitle').innerHTML = '';
    document.getElementById('modalBody').innerHTML = modalContent;
    document.getElementById('modalFooter').style.display = 'none';
    document.querySelector('.modal').classList.add('modal--popup');
    document.getElementById('modalOverlay').classList.add('modal-overlay--open');
}

function executeConfirm() {
    const callback = confirmCallback;
    closeModal();
    if (callback) {
        callback();
    }
}

function closeModal() {
    document.getElementById('modalOverlay').classList.remove('modal-overlay--open');
    document.querySelector('.modal').classList.remove('modal--popup');
    confirmCallback = null;
}

// ========== Class Selector ==========
function toggleClassDropdown() {
    const btn = document.getElementById('classButton');
    const dropdown = document.getElementById('classDropdown');
    btn.classList.toggle('open');
    dropdown.classList.toggle('class-dropdown--open');
}

function selectClass(id, name, status, dday) {
    if (status === 'ended') {
        if (confirm('종료된 클래스입니다. 기록 보기 화면으로 이동하시겠습니까?')) {
            showToast('종료된 클래스 기록을 불러옵니다', 'info');
        }
        toggleClassDropdown();
        return;
    }
    
    // 선택된 클래스 정보 업데이트
    document.getElementById('selectedClassName').textContent = name;
    document.getElementById('selectedClassDday').textContent = `D-${dday}`;
    
    // 활성 상태 업데이트
    document.querySelectorAll('.class-dropdown__item').forEach(item => {
        item.classList.toggle('class-dropdown__item--active', item.dataset.classId === id);
    });
    
    toggleClassDropdown();
    showToast(`${name} 클래스가 선택되었습니다`, 'success');
}

function openModal(title, body, showFooter = true, footerButtons = []) {
    document.getElementById('modalTitle').innerHTML = title;
    document.getElementById('modalBody').innerHTML = body;
    
    const footer = document.getElementById('modalFooter');
    if (showFooter && footerButtons.length > 0) {
        footer.style.display = 'flex';
        footer.innerHTML = footerButtons.map(btn => 
            `<button class="modal__btn ${btn.primary ? 'modal__btn--primary' : ''}" onclick="${btn.action}">${btn.text}</button>`
        ).join('');
    } else if (showFooter) {
        footer.style.display = 'flex';
        footer.innerHTML = '<button class="modal__btn modal__btn--primary" onclick="closeModal()">확인</button>';
    } else {
        footer.style.display = 'none';
    }
    
    document.getElementById('modalOverlay').classList.add('modal-overlay--open');
}

// ========== Search Modal ==========
function openSearchModal() {
    openModal('대화 검색', `
        <div style="margin-bottom: 16px;">
            <div style="position: relative;">
                <svg class="icon icon--sm" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-tertiary);" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                <input type="text" id="searchInput" placeholder="대화 내용 검색..." style="width: 100%; padding: 10px 12px 10px 40px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px;" oninput="filterSearchResults(this.value)">
            </div>
        </div>
        <div id="searchResults" style="max-height: 300px; overflow-y: auto;">
            <p style="color: var(--text-tertiary); font-size: 13px; text-align: center; padding: 20px;">검색어를 입력하세요</p>
        </div>
    `, false);
    setTimeout(() => document.getElementById('searchInput')?.focus(), 100);
}

function filterSearchResults(query) {
    const results = document.getElementById('searchResults');
    if (!query.trim()) {
        results.innerHTML = '<p style="color: var(--text-tertiary); font-size: 13px; text-align: center; padding: 20px;">검색어를 입력하세요</p>';
        return;
    }
    
    // chatData에서 검색
    const filteredChats = chatData.filter(chat => 
        chat.title.toLowerCase().includes(query.toLowerCase())
    );
    
    if (filteredChats.length === 0) {
        results.innerHTML = `
            <div style="text-align: center; padding: 30px; color: var(--text-tertiary);">
                <svg class="icon icon--lg" style="margin-bottom: 12px; opacity: 0.5;" viewBox="0 0 24 24">
                    <circle cx="11" cy="11" r="8"/>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                </svg>
                <p style="font-size: 13px;">"${escapeHtml(query)}"에 대한 검색 결과가 없습니다</p>
            </div>
        `;
        return;
    }
    
    results.innerHTML = `
        <div style="display: grid; gap: 8px;">
            ${filteredChats.map(chat => `
                <div style="padding: 12px; background: var(--surface); border-radius: 8px; cursor: pointer; transition: all 0.2s;" 
                     onclick="loadChat(${chat.id}); closeModal();"
                     onmouseover="this.style.background='var(--primary-50)'"
                     onmouseout="this.style.background='var(--surface)'">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="width: 32px; height: 32px; background: var(--primary-100); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: var(--primary-600);">
                            <svg class="icon icon--sm" viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                        </div>
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-weight: 500; margin-bottom: 2px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${escapeHtml(chat.title)}</div>
                            <div style="font-size: 11px; color: var(--text-tertiary); display: flex; align-items: center; gap: 8px;">
                                <span>${chat.time}</span>
                                ${chat.projectName ? `<span style="background: var(--primary-100); color: var(--primary-600); padding: 1px 6px; border-radius: 4px; font-size: 10px;">${chat.projectName}</span>` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `).join('')}
        </div>
    `;
}

// ========== Initialization ==========
document.addEventListener('DOMContentLoaded', () => {
    renderFileList();
    setupDragDrop();
    renderChatHistory();
});

document.addEventListener('click', (e) => {
    // 채팅 컨텍스트 메뉴 외부 클릭 감지
    if (!e.target.closest('.chat-item__menu') && !e.target.closest('#chatContextMenu')) {
        closeChatContextMenu();
    }
    // 파일 필터 드롭다운 외부 클릭 감지
    if (!e.target.closest('.file-filter')) {
        document.querySelectorAll('.file-filter__dropdown').forEach(d => d.classList.remove('show'));
        document.querySelectorAll('.file-filter__button').forEach(b => b.classList.remove('active'));
    }
    // 클래스 선택 드롭다운 외부 클릭 감지
    if (!e.target.closest('.class-selector')) {
        document.getElementById('classButton')?.classList.remove('open');
        document.getElementById('classDropdown')?.classList.remove('class-dropdown--open');
    }
});

document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        closeChatContextMenu();
        closeModal();
        // 클래스 드롭다운 닫기
        document.getElementById('classButton')?.classList.remove('open');
        document.getElementById('classDropdown')?.classList.remove('class-dropdown--open');
    }
});

// ========== Mode Selection ==========
function selectMode(mode) {
    currentMode = mode;
    
    document.getElementById('modeSelection').style.display = mode ? 'none' : 'block';
    document.getElementById('simpleUpload').classList.toggle('simple-upload--active', mode === 'simple');
    document.getElementById('advancedMode').classList.toggle('advanced-mode--active', mode === 'advanced');
    document.getElementById('compareMode').classList.toggle('active', mode === 'compare');
    
    // compare 모드일 때 kb-content 숨김 처리
    document.querySelector('.kb-content').style.display = mode === 'compare' ? 'none' : 'block';
    
    // Reset card states
    document.getElementById('simpleCard').classList.toggle('mode-card--active', mode === 'simple');
    document.getElementById('advancedCard').classList.toggle('mode-card--active', mode === 'advanced');
    document.getElementById('compareCard').classList.toggle('mode-card--active', mode === 'compare');
    
    if (mode === 'advanced') {
        currentStep = 1;
        updateStepper();
    }
}

function goBack() {
    selectMode(null);
}

// ========== Drag & Drop ==========
function setupDragDrop() {
    const zones = document.querySelectorAll('.upload-zone');
    zones.forEach(zone => {
        zone.addEventListener('dragover', (e) => {
            e.preventDefault();
            zone.classList.add('upload-zone--dragover');
        });
        zone.addEventListener('dragleave', () => {
            zone.classList.remove('upload-zone--dragover');
        });
        zone.addEventListener('drop', (e) => {
            e.preventDefault();
            zone.classList.remove('upload-zone--dragover');
            const mode = zone.id.includes('simple') ? 'simple' : 'advanced';
            handleFileUpload(e.dataTransfer.files, mode);
        });
    });
}

function handleFileUpload(files, mode) {
    const progressContainer = document.getElementById(mode === 'simple' ? 'simpleUploadProgress' : 'advancedUploadProgress');
    progressContainer.innerHTML = '';
    
    Array.from(files).forEach((file, index) => {
        const item = document.createElement('div');
        item.className = 'upload-progress__item';
        item.innerHTML = `
            <div class="upload-progress__icon">
                <svg class="icon" viewBox="0 0 24 24">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                    <polyline points="14 2 14 8 20 8"/>
                </svg>
            </div>
            <div class="upload-progress__info">
                <div class="upload-progress__name">${escapeHtml(file.name)}</div>
                <div class="upload-progress__bar">
                    <div class="upload-progress__fill" id="progress-${mode}-${index}" style="width: 0%"></div>
                </div>
            </div>
            <span class="upload-progress__status" id="status-${mode}-${index}">0%</span>
        `;
        progressContainer.appendChild(item);
        simulateProgress(mode, index, file.name);
    });
}

function simulateProgress(mode, index, fileName) {
    let progress = 0;
    const interval = setInterval(() => {
        progress += Math.random() * 15;
        if (progress >= 100) {
            progress = 100;
            clearInterval(interval);
            document.getElementById(`status-${mode}-${index}`).textContent = '완료';
            document.getElementById(`status-${mode}-${index}`).style.color = 'var(--success)';
            
            // Add to filesData
            filesData.push({
                id: Date.now(),
                name: fileName,
                type: fileName.split('.').pop(),
                size: '1.0 MB',
                status: 'failed',
                chunks: 0,
                date: new Date().toISOString().split('T')[0]
            });
            renderFileList();
            showToast('파일 업로드 완료', 'success');
        }
        document.getElementById(`progress-${mode}-${index}`).style.width = progress + '%';
        if (progress < 100) {
            document.getElementById(`status-${mode}-${index}`).textContent = Math.round(progress) + '%';
        }
    }, 200);
}

// ========== File List ==========
function renderFileList() {
    const grid = document.getElementById('fileGrid');
    const emptyState = document.getElementById('emptyState');
    const fileCount = document.getElementById('fileCount');
    const pagination = document.getElementById('pagination');
    const selectionBar = document.getElementById('selectionBar');
    
    // Update stats
    updateStats();
    
    const filteredFiles = getFilteredAndSortedFiles();
    
    if (filteredFiles.length === 0) {
        grid.style.display = 'none';
        emptyState.style.display = 'block';
        pagination.style.display = 'none';
        selectionBar.classList.add('hidden');
        if (filesData.length === 0) {
            document.querySelector('.empty-state__title').textContent = '파일이 없습니다';
            document.querySelector('.empty-state__desc').textContent = '파일을 업로드하여 지식베이스를 구축하세요';
            fileListState.selectedFiles = []; // Clear selection when no files
        } else {
            document.querySelector('.empty-state__title').textContent = '검색 결과가 없습니다';
            document.querySelector('.empty-state__desc').textContent = '다른 검색어나 필터를 사용해보세요';
        }
        fileCount.textContent = `${filteredFiles.length}개 / ${filesData.length}개 파일`;
        return;
    }
    
    grid.style.display = 'grid';
    emptyState.style.display = 'none';
    
    // Show filtered count if filtering is active
    if (fileListState.searchQuery || fileListState.statusFilter !== 'all') {
        fileCount.textContent = `${filteredFiles.length}개 / ${filesData.length}개 파일`;
    } else {
        fileCount.textContent = `${filesData.length}개 파일`;
    }
    
    // Keep view mode class
    grid.classList.toggle('file-grid--list', fileListState.viewMode === 'list');
    
    // Get paginated files
    const paginatedFiles = getPaginatedFiles(filteredFiles);
    
    grid.innerHTML = paginatedFiles.map(file => `
        <div class="file-card ${fileListState.selectedFiles.includes(file.id) ? 'selected' : ''}">
            <input type="checkbox" class="file-card__checkbox" data-file-id="${file.id}" 
                   ${fileListState.selectedFiles.includes(file.id) ? 'checked' : ''} 
                   onchange="toggleFileSelection(${file.id})">
            <div class="file-card__header">
                <div class="file-card__icon file-card__icon--${file.type}">
                    ${getFileIcon(file.type)}
                </div>
                <div class="file-card__info">
                    <div class="file-card__name">${escapeHtml(file.name)}</div>
                    <div class="file-card__meta">${file.size} · ${file.date}</div>
                </div>
            </div>
            <span class="file-card__status file-card__status--${file.status}">
                ${file.status === 'ready' ? '처리 완료' : '처리 실패'}
            </span>
            <div class="file-card__footer">
                <span class="file-card__chunks">${file.chunks}개 청크</span>
            </div>
        </div>
    `).join('');
    
    // Update selection UI
    updateSelectionUI();
    
    // Render pagination
    renderPagination(filteredFiles.length);
}

function getFileIcon(type) {
    return `<svg class="icon" viewBox="0 0 24 24">
        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
        <polyline points="14 2 14 8 20 8"/>
    </svg>`;
}

function showFileListSection() {
    document.getElementById('fileListSection').scrollIntoView({ behavior: 'smooth' });
}

// ========== Actions ==========
function previewChunks() {
    showToast('청크 프리뷰 생성 중...', 'info');
}

function createKnowledgeBase() {
    showToast('지식베이스 생성 중...', 'info');
    setTimeout(() => {
        showToast('지식베이스가 성공적으로 생성되었습니다!', 'success');
        goBack();
    }, 2000);
}

// ========== Utilities ==========
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text || '';
    return div.innerHTML;
}

// ========== Compare Mode Functions (New) ==========

// State Management for Compare Mode
const state = {
    currentModel: 'gpt',
    currentModelName: 'GPT-4',
    panels: {
        A: { mode: 'llm', selectedDoc: null, testRun: false },
        B: { mode: 'doc', selectedDoc: null, testRun: false }
    }
};

const modeLabels = {
    llm: { status: '순수 LLM', result: 'AI 응답', statusClass: 'mode-status--llm' },
    doc: { status: '문서 참조', result: 'AI 응답 (문서 참조)', statusClass: 'mode-status--doc' },
    rag: { status: 'RAG 설정', result: 'AI 응답 (RAG)', statusClass: 'mode-status--rag' }
};

const knowledgeBaseDocuments = [
    { id: 'doc1', name: '회사소개서.pdf', type: 'pdf', chunks: 128, size: '2.4 MB' },
    { id: 'doc2', name: '제품매뉴얼.pdf', type: 'pdf', chunks: 256, size: '5.1 MB' },
    { id: 'doc3', name: 'FAQ문서.txt', type: 'txt', chunks: 64, size: '124 KB' },
    { id: 'doc4', name: '기술문서.pdf', type: 'pdf', chunks: 189, size: '3.2 MB' },
    { id: 'doc5', name: '고객데이터.csv', type: 'csv', chunks: 95, size: '890 KB' },
    { id: 'doc6', name: 'AI학습가이드.pdf', type: 'pdf', chunks: 312, size: '4.8 MB' },
    { id: 'doc7', name: '프로젝트계획서.pdf', type: 'pdf', chunks: 78, size: '1.2 MB' },
    { id: 'doc8', name: '회의록_2024.txt', type: 'txt', chunks: 156, size: '320 KB' },
    { id: 'doc9', name: '분석보고서.pdf', type: 'pdf', chunks: 245, size: '6.3 MB' },
    { id: 'doc10', name: '사용자피드백.csv', type: 'csv', chunks: 89, size: '450 KB' },
];

function toggleModelDropdown() {
    const btn = document.getElementById('modelButton');
    const dropdown = document.getElementById('modelDropdown');
    btn.classList.toggle('active');
    dropdown.classList.toggle('show');
}


function selectModel(modelId, modelName) {
    state.currentModel = modelId;
    state.currentModelName = modelName;

    document.getElementById('selectedModelDot').className = `model-selector__dot model-selector__dot--${modelId}`;
    document.getElementById('selectedModelName').textContent = modelName;

    document.querySelectorAll('.model-dropdown__item').forEach(item => {
        item.classList.toggle('selected', item.dataset.model === modelId);
    });

    updateResultModelBadges();

    document.getElementById('modelButton').classList.remove('active');
    document.getElementById('modelDropdown').classList.remove('show');

    showToast(`${modelName} 모델이 선택되었습니다`, 'success');
}


function selectPanelMode(panel, mode) {
    state.panels[panel].mode = mode;
    
    const panelEl = document.getElementById(`panel${panel}`);
    panelEl.querySelectorAll('.mode-selector__item').forEach(item => {
        item.classList.toggle('active', item.dataset.mode === mode);
    });
    
    const statusEl = document.getElementById(`modeStatus${panel}`);
    statusEl.textContent = modeLabels[mode].status;
    statusEl.className = `mode-status ${modeLabels[mode].statusClass}`;
    
    document.getElementById(`llmContent${panel}`).classList.toggle('show', mode === 'llm');
    document.getElementById(`docContent${panel}`).classList.toggle('show', mode === 'doc');
    document.getElementById(`ragContent${panel}`).classList.toggle('show', mode === 'rag');
    
    document.getElementById(`resultLabel${panel}`).textContent = modeLabels[mode].result;
    
    const chunksEl = document.getElementById(`resultChunks${panel}`);
    chunksEl.textContent = mode === 'llm' ? '-' : '3개';
    
    document.getElementById(`resultBox${panel}`).classList.remove('show');
    state.panels[panel].testRun = false;
}

// ========== Model Selection ==========

function toggleDocDropdown(id) {
    const btn = document.getElementById(`docButton${id}`);
    const dropdown = document.getElementById(`docDropdown${id}`);
    
    // Close all other dropdowns
    document.querySelectorAll('.doc-dropdown').forEach(d => {
        if (d.id !== `docDropdown${id}`) d.classList.remove('show');
    });
    document.querySelectorAll('.doc-selector__button').forEach(b => {
        if (b.id !== `docButton${id}`) b.classList.remove('active');
    });
    
    btn.classList.toggle('active');
    dropdown.classList.toggle('show');
    
    // Focus search input
    if (dropdown.classList.contains('show')) {
        const searchInput = dropdown.querySelector('.doc-dropdown__search-input');
        if (searchInput) {
            setTimeout(() => searchInput.focus(), 100);
        }
    }
}


function selectDocument(dropdownId, docId) {
    const doc = knowledgeBaseDocuments.find(d => d.id === docId);
    if (!doc) return;
    
    const panel = dropdownId.slice(-1);
    const type = dropdownId.includes('Doc') ? 'doc' : 'rag';
    
    state.panels[panel].selectedDoc = doc;
    
    // Update UI
    const placeholder = document.getElementById(`docPlaceholder${dropdownId}`);
    const selected = document.getElementById(`docSelected${dropdownId}`);
    
    placeholder.style.display = 'none';
    selected.style.display = 'block';
    selected.querySelector('.doc-selector__name').textContent = doc.name;
    selected.querySelector('.doc-selector__meta').textContent = `${doc.chunks}개 청크 · ${doc.size}`;
    
    // Show settings
    if (type === 'doc') {
        document.getElementById(`defaultSettings${dropdownId}`).style.display = 'block';
    } else {
        document.getElementById(`settingsSection${dropdownId}`).style.display = 'block';
    }
    
    // Mark as selected in dropdown
    const dropdown = document.getElementById(`docDropdown${dropdownId}`);
    dropdown.querySelectorAll('.doc-dropdown__item').forEach(item => {
        item.classList.toggle('selected', item.dataset.docId === docId);
    });
    
    // Close dropdown
    document.getElementById(`docButton${dropdownId}`).classList.remove('active');
    dropdown.classList.remove('show');
    
    // Clear search
    const searchInput = dropdown.querySelector('.doc-dropdown__search-input');
    if (searchInput) searchInput.value = '';
    filterDocuments(dropdownId, '');
    
    showToast(`${doc.name} 문서가 선택되었습니다`, 'success');
}

// ========== Question Sync ==========

function updateSliderValue(id, value) {
    const suffix = id.includes('topK') ? '개' : (id.includes('chunk') ? '자' : '');
    document.getElementById(id + 'Value').textContent = value + suffix;
}

// ========== Test Execution ==========

function syncQuestion(sourcePanel) {
    const sourceQuestion = document.getElementById(`question${sourcePanel}`).value;
    const targetPanel = sourcePanel === 'A' ? 'B' : 'A';
    document.getElementById(`question${targetPanel}`).value = sourceQuestion;
}

// ========== Settings ==========

function runTest(panel) {
    const btn = document.getElementById('testBtn' + panel);
    const question = document.getElementById('question' + panel).value.trim();
    const mode = state.panels[panel].mode;
    
    if (!question) {
        showToast('질문을 입력해주세요', 'warning');
        return;
    }

    if (mode !== 'llm' && !state.panels[panel].selectedDoc) {
        showToast('문서를 먼저 선택해주세요', 'warning');
        return;
    }

    btn.disabled = true;
    btn.innerHTML = `
        <svg class="icon icon--sm" viewBox="0 0 24 24" style="animation: spin 1s linear infinite;">
            <path d="M21 12a9 9 0 1 1-6.219-8.56"/>
        </svg>
        분석 중...
    `;

    setTimeout(() => {
        document.getElementById('resultBox' + panel).classList.add('show');
        
        btn.disabled = false;
        btn.innerHTML = `
            <svg class="icon icon--sm" viewBox="0 0 24 24">
                <polygon points="5 3 19 12 5 21 5 3"/>
            </svg>
            실행
        `;

        state.panels[panel].testRun = true;
    }, 1500);
}

// ========== Utility Functions ==========

function resetPanel(panel) {
    // Reset mode to default
    selectPanelMode(panel, panel === 'A' ? 'llm' : 'doc');
    
    // Reset document selection
    const docTypes = ['Doc', 'Rag'];
    docTypes.forEach(type => {
        const id = type + panel;
        const placeholder = document.getElementById(`docPlaceholder${id}`);
        const selected = document.getElementById(`docSelected${id}`);
        if (placeholder) placeholder.style.display = 'block';
        if (selected) selected.style.display = 'none';
        
        // Hide settings
        if (type === 'Doc') {
            const defaultSettings = document.getElementById(`defaultSettings${id}`);
            if (defaultSettings) defaultSettings.style.display = 'none';
        } else {
            const settingsSection = document.getElementById(`settingsSection${id}`);
            if (settingsSection) settingsSection.style.display = 'none';
        }
        
        // Reset dropdown selection
        const dropdown = document.getElementById(`docDropdown${id}`);
        if (dropdown) {
            dropdown.querySelectorAll('.doc-dropdown__item').forEach(item => {
                item.classList.remove('selected');
            });
        }
    });
    
    // Reset sliders
    if (panel === 'A') {
        document.getElementById('topKA').value = 3;
        document.getElementById('topKAValue').textContent = '3개';
        document.getElementById('chunkSizeA').value = 500;
        document.getElementById('chunkSizeAValue').textContent = '500자';
        document.getElementById('thresholdA').value = 0.7;
        document.getElementById('thresholdAValue').textContent = '0.7';
    } else {
        document.getElementById('topKB').value = 5;
        document.getElementById('topKBValue').textContent = '5개';
        document.getElementById('chunkSizeB').value = 500;
        document.getElementById('chunkSizeBValue').textContent = '500자';
        document.getElementById('thresholdB').value = 0.7;
        document.getElementById('thresholdBValue').textContent = '0.7';
    }
    
    // Clear question
    document.getElementById(`question${panel}`).value = '';
    
    // Hide result
    document.getElementById(`resultBox${panel}`).classList.remove('show');
    
    // Reset state
    state.panels[panel].selectedDoc = null;
    state.panels[panel].testRun = false;
    
    showToast(`패널 ${panel}이 초기화되었습니다`, 'success');
}

// ========== Mode Selection ==========

// Initialize document dropdowns on load
document.addEventListener('DOMContentLoaded', function() {
    renderDocDropdowns();
});

// ========== Render Document Dropdowns ==========
function renderDocDropdowns() {
    const dropdownIds = ['DocA', 'DocB', 'RagA', 'RagB'];
    
    dropdownIds.forEach(id => {
        const dropdown = document.getElementById(`docDropdown${id}`);
        if (!dropdown) return;
        
        if (knowledgeBaseDocuments.length === 0) {
            dropdown.innerHTML = '<div class="doc-dropdown__empty">업로드된 문서가 없습니다</div>';
            return;
        }
        
        dropdown.innerHTML = `
            <div class="doc-dropdown__search">
                <input type="text" class="doc-dropdown__search-input" placeholder="문서 검색..." oninput="filterDocuments('${id}', this.value)">
            </div>
            <div class="doc-dropdown__list">
                ${knowledgeBaseDocuments.map(doc => `
                    <div class="doc-dropdown__item" data-doc-id="${doc.id}" data-doc-name="${doc.name.toLowerCase()}" onclick="selectDocument('${id}', '${doc.id}')">
                        <div class="doc-dropdown__item-icon doc-dropdown__item-icon--${doc.type}">
                            <svg class="icon icon--sm" viewBox="0 0 24 24">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                <polyline points="14 2 14 8 20 8"/>
                            </svg>
                        </div>
                        <div class="doc-dropdown__item-info">
                            <div class="doc-dropdown__item-name">${doc.name}</div>
                            <div class="doc-dropdown__item-meta">${doc.chunks}개 청크 · ${doc.size}</div>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
    });
}

function filterDocuments(dropdownId, searchTerm) {
    const dropdown = document.getElementById(`docDropdown${dropdownId}`);
    const items = dropdown.querySelectorAll('.doc-dropdown__item');
    const term = searchTerm.toLowerCase();
    
    items.forEach(item => {
        const name = item.dataset.docName;
        item.classList.toggle('hidden', !name.includes(term));
    });
}

function updateResultModelBadges() {
    const modelClass = `result-card__model result-card__model--${state.currentModel}`;
    const dotClass = `model-selector__dot model-selector__dot--${state.currentModel}`;
    
    ['A', 'B'].forEach(panel => {
        const badge = document.getElementById(`resultModel${panel}`);
        if (badge) {
            badge.className = modelClass;
            badge.innerHTML = `<span class="${dotClass}"></span>${state.currentModelName}`;
        }
    });
}

function showToast(message, type = 'info') {
    const existing = document.querySelector('.toast');
    if (existing) existing.remove();

    const toast = document.createElement('div');
    toast.className = `toast ${type !== 'info' ? 'toast--' + type : ''}`;
    toast.textContent = message;
    document.body.appendChild(toast);

    setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 300);
    }, 2500);
}

// Close dropdowns when clicking outside
document.addEventListener('click', (e) => {
    if (!e.target.closest('.model-selector__dropdown')) {
        const btn = document.getElementById('modelButton');
        const dropdown = document.getElementById('modelDropdown');
        if (btn) btn.classList.remove('active');
        if (dropdown) dropdown.classList.remove('show');
    }
    if (!e.target.closest('.doc-selector__dropdown')) {
        document.querySelectorAll('.doc-dropdown').forEach(d => d.classList.remove('show'));
        document.querySelectorAll('.doc-selector__button').forEach(b => b.classList.remove('active'));
    }
    if (!e.target.closest('.file-filter')) {
        document.querySelectorAll('.file-filter__dropdown').forEach(d => d.classList.remove('show'));
        document.querySelectorAll('.file-filter__button').forEach(b => b.classList.remove('active'));
    }
});

// ========== Chunk Preview Split View ==========
let isChunkPreviewOpen = false;
let currentChunkingMode = 'normal'; // 'normal' or 'parent-child'

// 샘플 문서 텍스트 (실제로는 업로드된 파일에서 가져옴)
const sampleDocumentText = `인공지능(AI)은 인간의 학습능력, 추론능력, 지각능력, 자연언어의 이해능력 등을 컴퓨터 프로그램으로 실현한 기술입니다.

머신러닝은 인공지능의 한 분야로, 컴퓨터가 데이터를 분석하고 패턴을 학습하여 스스로 성능을 개선하는 기술입니다. 지도학습, 비지도학습, 강화학습 등 다양한 방식이 있습니다.

딥러닝은 인공신경망을 기반으로 한 머신러닝의 한 종류입니다. 여러 층의 신경망을 통해 복잡한 패턴을 학습할 수 있으며, 이미지 인식, 음성 인식, 자연어 처리 등에서 뛰어난 성능을 보입니다.

자연어 처리(NLP)는 컴퓨터가 인간의 언어를 이해하고 처리하는 기술입니다. 텍스트 분석, 감정 분석, 기계 번역, 챗봇 등 다양한 응용 분야가 있습니다.

대규모 언어 모델(LLM)은 방대한 텍스트 데이터로 학습된 딥러닝 모델입니다. GPT, Claude, Gemini 등이 대표적이며, 다양한 자연어 작업을 수행할 수 있습니다.

RAG(Retrieval-Augmented Generation)는 검색과 생성을 결합한 기술입니다. 외부 지식베이스에서 관련 정보를 검색하여 LLM의 응답 품질을 향상시킵니다.

청킹은 긴 문서를 작은 조각으로 나누는 과정입니다. 적절한 청킹 전략은 RAG 시스템의 검색 정확도와 응답 품질에 큰 영향을 미칩니다.

벡터 임베딩은 텍스트를 수치 벡터로 변환하는 기술입니다. 의미적으로 유사한 텍스트는 벡터 공간에서 가까운 거리에 위치하게 됩니다.

벡터 데이터베이스는 벡터 임베딩을 저장하고 유사도 검색을 수행하는 데이터베이스입니다. Pinecone, Weaviate, Chroma 등이 대표적입니다.

프롬프트 엔지니어링은 AI 모델에 효과적인 입력을 설계하는 기술입니다. 좋은 프롬프트는 모델의 성능을 크게 향상시킬 수 있습니다.`;

function toggleChunkPreview() {
    isChunkPreviewOpen = !isChunkPreviewOpen;
    
    const stepCard = document.getElementById('chunkingStepCard');
    const previewPanel = document.getElementById('chunkPreviewPanel');
    const previewBtn = document.getElementById('previewChunkBtn');
    const previewBtnText = document.getElementById('previewBtnText');
    const advancedMode = document.querySelector('.advanced-mode');
    
    if (isChunkPreviewOpen) {
        // 분할 모드 활성화
        stepCard.classList.add('step-card--split');
        previewPanel.style.display = 'flex';
        previewBtn.classList.add('btn--preview-active');
        previewBtnText.textContent = '프리뷰 닫기';
        advancedMode.classList.add('advanced-mode--split');
        
        // 청크 미리보기 생성
        generateChunkPreview();
    } else {
        // 분할 모드 비활성화
        stepCard.classList.remove('step-card--split');
        previewPanel.style.display = 'none';
        previewBtn.classList.remove('btn--preview-active');
        previewBtnText.textContent = '프리뷰 청크';
        advancedMode.classList.remove('advanced-mode--split');
    }
}

function getSelectedChunkingMode() {
    const optionCards = document.querySelectorAll('#step2 .option-cards .option-card');
    let mode = 'normal';
    optionCards.forEach((card, index) => {
        if (card.classList.contains('option-card--active')) {
            mode = index === 0 ? 'normal' : 'parent-child';
        }
    });
    return mode;
}

function generateChunkPreview() {
    const maxChunkLength = parseInt(document.getElementById('maxChunkLength').value) || 1024;
    const chunkOverlap = parseInt(document.getElementById('chunkOverlap').value) || 50;
    const replaceSpaces = document.getElementById('replaceSpaces').checked;
    const removeUrls = document.getElementById('removeUrls').checked;
    const chunkingMode = getSelectedChunkingMode();
    
    // 텍스트 전처리
    let processedText = sampleDocumentText;
    if (replaceSpaces) {
        processedText = processedText.replace(/\s+/g, ' ');
    }
    if (removeUrls) {
        processedText = processedText.replace(/https?:\/\/[^\s]+/g, '');
        processedText = processedText.replace(/[\w.-]+@[\w.-]+\.\w+/g, '');
    }
    
    // 청킹 수행
    const paragraphs = processedText.split('\n\n').filter(p => p.trim());
    
    if (chunkingMode === 'normal') {
        generateNormalChunks(paragraphs, maxChunkLength, chunkOverlap);
    } else {
        generateParentChildChunks(paragraphs, maxChunkLength, chunkOverlap);
    }
}

function generateNormalChunks(paragraphs, maxChunkLength, chunkOverlap) {
    const chunks = [];
    let currentChunk = '';
    let chunkIndex = 1;
    
    paragraphs.forEach((para, i) => {
        if (currentChunk.length + para.length <= maxChunkLength) {
            currentChunk += (currentChunk ? '\n\n' : '') + para;
        } else {
            if (currentChunk) {
                chunks.push({
                    id: chunkIndex++,
                    text: currentChunk,
                    length: currentChunk.length,
                    overlap: chunkOverlap,
                    type: 'normal'
                });
            }
            currentChunk = para;
        }
    });
    
    if (currentChunk) {
        chunks.push({
            id: chunkIndex++,
            text: currentChunk,
            length: currentChunk.length,
            overlap: chunkOverlap,
            type: 'normal'
        });
    }
    
    renderChunkPreview(chunks, 'normal');
}

function generateParentChildChunks(paragraphs, maxChunkLength, chunkOverlap) {
    const chunks = [];
    let parentIndex = 1;
    let childIndex = 1;
    
    // 부모 청크 크기는 자식의 2-3배
    const parentChunkLength = maxChunkLength * 2.5;
    const childChunkLength = Math.floor(maxChunkLength / 2);
    
    let currentParent = '';
    let currentParentParagraphs = [];
    
    paragraphs.forEach((para, i) => {
        if (currentParent.length + para.length <= parentChunkLength) {
            currentParent += (currentParent ? '\n\n' : '') + para;
            currentParentParagraphs.push(para);
        } else {
            if (currentParent) {
                // 부모 청크 추가
                const parentId = parentIndex++;
                chunks.push({
                    id: `P${parentId}`,
                    text: currentParent,
                    length: currentParent.length,
                    overlap: chunkOverlap,
                    type: 'parent',
                    childCount: 0
                });
                
                // 자식 청크들 생성
                let childCount = 0;
                currentParentParagraphs.forEach(childPara => {
                    if (childPara.length > 0) {
                        chunks.push({
                            id: `C${childIndex++}`,
                            text: childPara,
                            length: childPara.length,
                            overlap: Math.floor(chunkOverlap / 2),
                            type: 'child',
                            parentId: `P${parentId}`
                        });
                        childCount++;
                    }
                });
                
                // 부모의 자식 수 업데이트
                const parentChunk = chunks.find(c => c.id === `P${parentId}`);
                if (parentChunk) parentChunk.childCount = childCount;
            }
            currentParent = para;
            currentParentParagraphs = [para];
        }
    });
    
    // 마지막 부모-자식 청크 추가
    if (currentParent) {
        const parentId = parentIndex++;
        chunks.push({
            id: `P${parentId}`,
            text: currentParent,
            length: currentParent.length,
            overlap: chunkOverlap,
            type: 'parent',
            childCount: 0
        });
        
        let childCount = 0;
        currentParentParagraphs.forEach(childPara => {
            if (childPara.length > 0) {
                chunks.push({
                    id: `C${childIndex++}`,
                    text: childPara,
                    length: childPara.length,
                    overlap: Math.floor(chunkOverlap / 2),
                    type: 'child',
                    parentId: `P${parentId}`
                });
                childCount++;
            }
        });
        
        const parentChunk = chunks.find(c => c.id === `P${parentId}`);
        if (parentChunk) parentChunk.childCount = childCount;
    }
    
    renderChunkPreview(chunks, 'parent-child');
}

function renderChunkPreview(chunks, mode) {
    const parentChunks = chunks.filter(c => c.type === 'parent');
    const childChunks = chunks.filter(c => c.type === 'child');
    const normalChunks = chunks.filter(c => c.type === 'normal');
    
    // 통계 업데이트
    const previewTitle = document.querySelector('.step-card__preview-title');
    const statsContainer = document.querySelector('.step-card__preview-stats');
    
    if (mode === 'normal') {
        previewTitle.innerHTML = `
            <svg class="icon icon--sm" viewBox="0 0 24 24">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                <line x1="3" y1="9" x2="21" y2="9"/>
                <line x1="3" y1="15" x2="21" y2="15"/>
            </svg>
            청크 미리보기
        `;
        
        const avgLength = normalChunks.length > 0 
            ? Math.round(normalChunks.reduce((sum, c) => sum + c.length, 0) / normalChunks.length) 
            : 0;
        
        statsContainer.innerHTML = `
            <div class="preview-stat">
                <div class="preview-stat__value">${normalChunks.length}</div>
                <div class="preview-stat__label">총 청크 수</div>
            </div>
            <div class="preview-stat">
                <div class="preview-stat__value">${avgLength}</div>
                <div class="preview-stat__label">평균 길이</div>
            </div>
        `;
    } else {
        previewTitle.innerHTML = `
            <svg class="icon icon--sm" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="4"/>
                <circle cx="12" cy="12" r="9"/>
            </svg>
            부모-자식 미리보기
        `;
        
        const avgParentLength = parentChunks.length > 0 
            ? Math.round(parentChunks.reduce((sum, c) => sum + c.length, 0) / parentChunks.length) 
            : 0;
        const avgChildLength = childChunks.length > 0 
            ? Math.round(childChunks.reduce((sum, c) => sum + c.length, 0) / childChunks.length) 
            : 0;
        
        statsContainer.innerHTML = `
            <div class="preview-stat" style="background: linear-gradient(135deg, #dbeafe, #eff6ff); border-color: #93c5fd;">
                <div class="preview-stat__value" style="color: #2563eb;">${parentChunks.length}</div>
                <div class="preview-stat__label">부모 청크</div>
            </div>
            <div class="preview-stat" style="background: linear-gradient(135deg, #fef3c7, #fffbeb); border-color: #fcd34d;">
                <div class="preview-stat__value" style="color: #d97706;">${childChunks.length}</div>
                <div class="preview-stat__label">자식 청크</div>
            </div>
            <div class="preview-stat">
                <div class="preview-stat__value">${avgChildLength}</div>
                <div class="preview-stat__label">자식 평균</div>
            </div>
        `;
    }
    
    // 청크 리스트 렌더링
    const chunkList = document.getElementById('chunkPreviewList');
    
    if (chunks.length === 0) {
        chunkList.innerHTML = `
            <div class="step-card__preview-empty">
                <svg class="icon" viewBox="0 0 24 24">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                    <polyline points="14 2 14 8 20 8"/>
                </svg>
                <div class="step-card__preview-empty-text">
                    청크를 생성할 문서가 없습니다.<br>
                    먼저 파일을 업로드해주세요.
                </div>
            </div>
        `;
        return;
    }
    
    // 문서형 프리뷰 렌더링
    if (mode === 'normal') {
        let html = '<div class="doc-preview">';
        
        chunks.forEach((chunk, index) => {
            // 청크 구분선 (첫 번째 제외)
            if (index > 0) {
                html += `
                    <div class="doc-preview__divider">
                        <div class="doc-preview__divider-icon">${chunk.id}</div>
                        <div class="doc-preview__divider-info">청크 #${chunk.id} 시작</div>
                        <div class="doc-preview__divider-meta">${chunk.length}자 · 중첩 ${chunk.overlap}자</div>
                    </div>
                `;
            }
            
            html += `
                <div class="doc-preview__chunk ${index % 2 === 1 ? 'doc-preview__chunk--even' : ''}" data-label="청크 #${chunk.id} · ${chunk.length}자">
                    ${escapeHtml(chunk.text)}
                </div>
            `;
        });
        
        html += '</div>';
        chunkList.innerHTML = html;
        
    } else {
        // 부모-자식 문서형 프리뷰
        let html = '<div class="doc-preview">';
        
        parentChunks.forEach((parent, pIndex) => {
            const children = childChunks.filter(c => c.parentId === parent.id);
            
            // 부모 구분선 (첫 번째 제외)
            if (pIndex > 0) {
                html += `
                    <div class="doc-preview__divider doc-preview__parent-divider">
                        <div class="doc-preview__divider-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 12px; height: 12px;">
                                <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
                            </svg>
                        </div>
                        <div class="doc-preview__divider-info">부모 ${parent.id} 시작</div>
                        <div class="doc-preview__divider-meta">${parent.length}자 · ${children.length}개 자식</div>
                    </div>
                `;
            }
            
            html += `
                <div class="doc-preview__chunk doc-preview__parent" data-label="📁 부모 ${parent.id} · ${parent.length}자">
                    <div style="margin-bottom: 12px; color: var(--text-secondary);">${escapeHtml(parent.text)}</div>
                    
                    <div class="doc-preview__child-section">
                        <div style="font-size: 11px; color: #2563eb; font-weight: 600; margin-bottom: 8px; display: flex; align-items: center; gap: 6px;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;">
                                <circle cx="11" cy="11" r="8"/>
                                <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                            </svg>
                            자식 청크 (검색 단위)
                        </div>
                        ${children.map((child, cIndex) => `
                            <div class="doc-preview__child" data-label="🔍 ${child.id}">
                                ${escapeHtml(child.text)}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
        chunkList.innerHTML = html;
    }
}

function updateChunkPreview() {
    // 디바운스를 위한 타이머
    if (window.chunkPreviewTimer) {
        clearTimeout(window.chunkPreviewTimer);
    }
    
    window.chunkPreviewTimer = setTimeout(() => {
        if (isChunkPreviewOpen) {
            generateChunkPreview();
        }
    }, 300);
}

function refreshChunkPreview() {
    const refreshBtn = document.getElementById('refreshPreviewBtn');
    refreshBtn.classList.add('preview-refresh-btn--loading');
    
    setTimeout(() => {
        generateChunkPreview();
        refreshBtn.classList.remove('preview-refresh-btn--loading');
        showToast('미리보기가 새로고침되었습니다', 'success');
    }, 500);
}

// escapeHtml 함수 (이미 있으면 스킵)
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

</script>
</body>
</html>
